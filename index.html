<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>Retention Tontine ‚Äî Launcher & Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>

  <!-- jQuery + Ethers v6 -->
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.10.0/ethers.umd.min.js"></script>

  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Helvetica,Arial,sans-serif; background:#0b0f14; color:#e6edf3; margin:0; padding:24px}
    h1,h2{margin:.2rem 0}
    .card{background:#121823; border:1px solid #263241; border-radius:14px; padding:16px; margin:12px 0}
    label{display:block; margin:8px 0 4px}
    input,select,button{padding:10px; border-radius:10px; border:1px solid #2b3a4d; background:#0e141c; color:#e6edf3}
    input,select{width:100%}
    button{cursor:pointer; background:#1b2738}
    button:hover{background:#223047}
    .row{display:grid; grid-template-columns:1fr 1fr; gap:12px}
    .muted{color:#92a0b3; font-size:.9em}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace}
    .pill{display:inline-block; padding:2px 8px; border:1px solid #2b3a4d; border-radius:999px; font-size:.85em; margin-left:6px}
    .ok{color:#17d992} .warn{color:#ffcf5a} .bad{color:#ff6b6b}
    .grid3{display:grid; grid-template-columns:repeat(3,1fr); gap:12px}
    small{color:#9bb0c2}
    .flex{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
    .addr{font-size:.9em}
    .hr{height:1px; background:#263241; margin:12px 0}
    a{color:#78a6ff; text-decoration:none}
  </style>
</head>
<body>
  <h1>Retention Tontine üè¥‚Äç‚ò†Ô∏è</h1>
  <div class="muted"><i>Deploy & interact with <span class="mono">retention<a href="https://en.wikipedia.org/wiki/Tontine"> tontine</a> contracts</span> using your browser wallet.</i></div>
  <div>---------------------------------------</div>
  <div class="muted">In a traditional tontine, money is pooled among a group of people and whenever someone dies, their share is paid out to the living members of the contract. This was once a popular way to provide annuities or fund public goods like the <a href='https://en.wikipedia.org/wiki/Richmond_Bridge,_London'>Richmond Bridge</a> in London.</div>
  <div>---------------------------------------</div>
  <div class="muted">In this retention tontine, participants compete to hold assets to the end of the contract term. Early withdrawals pay a 20% penalty into a fee pool for remaining holders. You may withdraw penalty-free before the enrollment period ends or if you are the "last man standing" in the contract, and partial withdrawals are allowed.</div>
  <div>---------------------------------------</div>
  <div>Current official mainnet BITCOIN tontine contract (load it below!): 0x4091529c0D13A1276ddcd51bfaF1e54c2dE64c08 (<a href='https://www.google.com'>etherscan</a>)</div>

  <!-- Connect / Network -->
  <div class="card">
    <div class="flex" style="gap:12px; align-items:center">
      <button id="btnConnect">üîå Connect Wallet</button>
      <div id="connStatus" class="pill">Not connected</div>
      <div id="netStatus" class="pill">Network: ‚Äî</div>
      <div id="acct" class="mono addr"></div>
      <div style="margin-left:auto; min-width:220px">
        <label class="muted" style="margin:0 0 6px">Select Network</label>
        <select id="networkSelect">
          <option value="sepolia" selected>Sepolia (testnet)</option>
          <option value="mainnet">Ethereum Mainnet</option>
        </select>
      </div>
      <button id="btnSwitch">üîÑ Switch in Wallet</button>
    </div>
    <small class="muted">All reads/writes use your wallet‚Äôs provider. Connect first to see data.</small>
  </div>

  <!-- Deploy -->
  <div class="card">
    <h2>Launch New Tontine</h2>
    <div class="row">
      <div>
        <label>ERC-20 Token Address (default varies by network)</label>
        <input id="inpToken" placeholder="0x... token"/>
      </div>
      <div>
        <label>Token Decimals</label>
        <input id="inpDecimals" type="number"/>
      </div>
    </div>
    <div class="row">
      <div>
        <label>Enrollment Duration (minutes)</label>
        <input id="inpEnrollMin" type="number" value="5"/>
      </div>
      <div>
        <label>Lock Duration (minutes, starts after enrollment)</label>
        <input id="inpLockMin" type="number" value="10"/>
      </div>
    </div>
    <div class="flex">
      <button id="btnDeploy">üöÄ Deploy</button>
      <div class="muted">After deploy, the contract appears below.</div>
    </div>
  </div>

  <!-- Add existing -->
  <div class="card">
    <h2>Load Existing Tontine</h2>
    <div class="row">
      <div>
        <label>Tontine Contract Address</label>
        <input id="inpExisting" placeholder="0x... tontine contract"/>
      </div>
      <div>
        <label>&nbsp;</label>
        <button id="btnAddExisting">‚ûï Add</button>
      </div>
    </div>
  </div>

  <!-- Dashboard -->
  <div id="dash"></div>

  <!-- fun images -->
  <img src="https://s2.coinmarketcap.com/static/img/coins/200x200/25220.png">
  <img src="images/tontineart1.jpg">
  <img src="images/tontineart2.jpg">
  <img src="images/tontine3.png">
  <div> js and contract code: <a href="https://github.com/sprotogremlin2025/retention-tontine-live">https://github.com/sprotogremlin2025/retention-tontine-live</a></div>
  <script>
    // --------- NETWORK CONFIG (no RPC URLs) ----------
    const NETWORKS = {
      sepolia: {
        key: 'sepolia',
        name: 'Sepolia',
        chainIdHex: '0xaa36a7',
        etherscan: 'https://sepolia.etherscan.io',
        defaultToken: '0x1c7D4B196Cb0C7B01d743Fbc6116a902379C7238', // USDC (Sepolia)
        defaultDecimals: 6
      },
      mainnet: {
        key: 'mainnet',
        name: 'Ethereum Mainnet',
        chainIdHex: '0x1',
        etherscan: 'https://etherscan.io',
        // Default to BITCOIN token on mainnet
        defaultToken: '0x72e4f9F808C49A2a61dE9C5896298920Dc4EEEa9', // BITCOIN
        defaultDecimals: 18 // will autofill from chain after connect
      }
    };

    // --------- ABIs ----------
    const ERC20_ABI = [
      "function decimals() view returns (uint8)",
      "function balanceOf(address) view returns (uint256)",
      "function allowance(address owner, address spender) view returns (uint256)",
      "function approve(address spender, uint256 amount) returns (bool)"
    ];

    const TONTINE_ABI = [
      
        {
          "inputs": [
            {
              "internalType": "address",
              "name": "_token",
              "type": "address"
            },
            {
              "internalType": "uint256",
              "name": "_enrollmentDuration",
              "type": "uint256"
            },
            {
              "internalType": "uint256",
              "name": "_lockDuration",
              "type": "uint256"
            }
          ],
          "stateMutability": "nonpayable",
          "type": "constructor"
        },
        {
          "inputs": [
            {
              "internalType": "address",
              "name": "token",
              "type": "address"
            }
          ],
          "name": "SafeERC20FailedOperation",
          "type": "error"
        },
        {
          "anonymous": false,
          "inputs": [
            {
              "indexed": true,
              "internalType": "address",
              "name": "user",
              "type": "address"
            },
            {
              "indexed": false,
              "internalType": "uint256",
              "name": "amount",
              "type": "uint256"
            }
          ],
          "name": "Deposited",
          "type": "event"
        },
        {
          "anonymous": false,
          "inputs": [
            {
              "indexed": true,
              "internalType": "address",
              "name": "user",
              "type": "address"
            },
            {
              "indexed": false,
              "internalType": "uint256",
              "name": "shareFromPool",
              "type": "uint256"
            }
          ],
          "name": "FeeDistributed",
          "type": "event"
        },
        {
          "anonymous": false,
          "inputs": [
            {
              "indexed": true,
              "internalType": "address",
              "name": "user",
              "type": "address"
            },
            {
              "indexed": false,
              "internalType": "uint256",
              "name": "amountRequested",
              "type": "uint256"
            },
            {
              "indexed": false,
              "internalType": "uint256",
              "name": "paidOut",
              "type": "uint256"
            },
            {
              "indexed": false,
              "internalType": "uint256",
              "name": "penaltyToPool",
              "type": "uint256"
            }
          ],
          "name": "PartialWithdrawn",
          "type": "event"
        },
        {
          "anonymous": false,
          "inputs": [
            {
              "indexed": true,
              "internalType": "address",
              "name": "user",
              "type": "address"
            },
            {
              "indexed": false,
              "internalType": "uint256",
              "name": "paidOut",
              "type": "uint256"
            },
            {
              "indexed": false,
              "internalType": "uint256",
              "name": "penaltyToPool",
              "type": "uint256"
            }
          ],
          "name": "WithdrawnAll",
          "type": "event"
        },
        {
          "inputs": [
            {
              "internalType": "address",
              "name": "",
              "type": "address"
            }
          ],
          "name": "accounts",
          "outputs": [
            {
              "internalType": "uint256",
              "name": "entitlement",
              "type": "uint256"
            },
            {
              "internalType": "uint256",
              "name": "deposited",
              "type": "uint256"
            },
            {
              "internalType": "uint256",
              "name": "rewardDebt",
              "type": "uint256"
            }
          ],
          "stateMutability": "view",
          "type": "function"
        },
        {
          "inputs": [
            {
              "internalType": "uint256",
              "name": "amount",
              "type": "uint256"
            }
          ],
          "name": "deposit",
          "outputs": [],
          "stateMutability": "nonpayable",
          "type": "function"
        },
        {
          "inputs": [],
          "name": "enrollmentEnd",
          "outputs": [
            {
              "internalType": "uint256",
              "name": "",
              "type": "uint256"
            }
          ],
          "stateMutability": "view",
          "type": "function"
        },
        {
          "inputs": [],
          "name": "feePool",
          "outputs": [
            {
              "internalType": "uint256",
              "name": "",
              "type": "uint256"
            }
          ],
          "stateMutability": "view",
          "type": "function"
        },
        {
          "inputs": [
            {
              "internalType": "address",
              "name": "user",
              "type": "address"
            }
          ],
          "name": "getAccount",
          "outputs": [
            {
              "internalType": "uint256",
              "name": "entitlement",
              "type": "uint256"
            },
            {
              "internalType": "uint256",
              "name": "deposited",
              "type": "uint256"
            }
          ],
          "stateMutability": "view",
          "type": "function"
        },
        {
          "inputs": [],
          "name": "payoutTime",
          "outputs": [
            {
              "internalType": "uint256",
              "name": "",
              "type": "uint256"
            }
          ],
          "stateMutability": "view",
          "type": "function"
        },
        {
          "inputs": [],
          "name": "timeUntilPayout",
          "outputs": [
            {
              "internalType": "uint256",
              "name": "",
              "type": "uint256"
            }
          ],
          "stateMutability": "view",
          "type": "function"
        },
        {
          "inputs": [],
          "name": "token",
          "outputs": [
            {
              "internalType": "contract IERC20",
              "name": "",
              "type": "address"
            }
          ],
          "stateMutability": "view",
          "type": "function"
        },
        {
          "inputs": [],
          "name": "totalDeposits",
          "outputs": [
            {
              "internalType": "uint256",
              "name": "",
              "type": "uint256"
            }
          ],
          "stateMutability": "view",
          "type": "function"
        },
        {
          "inputs": [
            {
              "internalType": "uint256",
              "name": "amount",
              "type": "uint256"
            }
          ],
          "name": "withdraw",
          "outputs": [],
          "stateMutability": "nonpayable",
          "type": "function"
        }
      ];

    // If you deploy from the UI, paste your bytecode (unchanged)
    const TONTINE_BYTECODE = "60e060405234801561000f575f5ffd5b5060405161140e38038061140e83398181016040528101906100319190610194565b5f73ffffffffffffffffffffffffffffffffffffffff168373ffffffffffffffffffffffffffffffffffffffff160361009f576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016100969061023e565b60405180910390fd5b8273ffffffffffffffffffffffffffffffffffffffff1660808173ffffffffffffffffffffffffffffffffffffffff168152505081426100df9190610289565b60a081815250508060a0516100f49190610289565b60c081815250505050506102bc565b5f5ffd5b5f73ffffffffffffffffffffffffffffffffffffffff82169050919050565b5f61013082610107565b9050919050565b61014081610126565b811461014a575f5ffd5b50565b5f8151905061015b81610137565b92915050565b5f819050919050565b61017381610161565b811461017d575f5ffd5b50565b5f8151905061018e8161016a565b92915050565b5f5f5f606084860312156101ab576101aa610103565b5b5f6101b88682870161014d565b93505060206101c986828701610180565b92505060406101da86828701610180565b9150509250925092565b5f82825260208201905092915050565b7f746f6b656e3d30000000000000000000000000000000000000000000000000005f82015250565b5f6102286007836101e4565b9150610233826101f4565b602082019050919050565b5f6020820190508181035f8301526102558161021c565b9050919050565b7f4e487b71000000000000000000000000000000000000000000000000000000005f52601160045260245ffd5b5f61029382610161565b915061029e83610161565b92508282019050808211156102b6576102b561025c565b5b92915050565b60805160a05160c0516110f76103175f395f8181610729015281816107590152818161078a01526108f101525f81816104e90152818161053e01526108c201525f818161036101528181610631015261081601526110f75ff3fe608060405234801561000f575f5ffd5b506004361061009c575f3560e01c8063b6b55f2511610064578063b6b55f2514610148578063c4df0c0914610164578063ed5f41ff14610182578063fbcbc0f1146101a0578063fc0c546a146101d15761009c565b80632e1a7d4d146100a05780634a5b5a8a146100bc5780635e5c06e2146100da5780637d8820971461010c578063ae2e933b1461012a575b5f5ffd5b6100ba60048036038101906100b59190610c1c565b6101ef565b005b6100c46104e7565b6040516100d19190610c56565b60405180910390f35b6100f460048036038101906100ef9190610cc9565b61050b565b60405161010393929190610cf4565b60405180910390f35b610114610531565b6040516101219190610c56565b60405180910390f35b610132610536565b60405161013f9190610c56565b60405180910390f35b610162600480360381019061015d9190610c1c565b61053c565b005b61016c610726565b6040516101799190610c56565b60405180910390f35b61018a610788565b6040516101979190610c56565b60405180910390f35b6101ba60048036038101906101b59190610cc9565b6107ac565b6040516101c8929190610d29565b60405180910390f35b6101d9610814565b6040516101e69190610dab565b60405180910390f35b5f60035f3373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020015f2090505f8211610271576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161026890610e1e565b60405180910390fd5b81816001015410156102b8576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016102af90610e86565b60405180910390fd5b6102c181610838565b5f6102d08383600101546108af565b90505f606482856102e19190610ed1565b6102eb9190610f3f565b90505f81856102fa9190610f6f565b905084846001015f82825461030f9190610f6f565b92505081905550845f5f8282546103269190610f6f565b925050819055505f8211156103405761033f8285610929565b5b5f845f0154826103509190610fa2565b90505f8111156103ff576103a533827f000000000000000000000000000000000000000000000000000000000000000073ffffffffffffffffffffffffffffffffffffffff166109f39092919063ffffffff16565b3373ffffffffffffffffffffffffffffffffffffffff167f6c461460f28af1386f23dc4c0c7f4e2e54f0db320a8edc08803e4b787f6db325865f01546040516103ee9190610c56565b60405180910390a25f855f01819055505b670de0b6b3a7640000600254866001015461041a9190610ed1565b6104249190610f3f565b85600201819055505f85600101540361048c573373ffffffffffffffffffffffffffffffffffffffff167f8f420e722d4b21a3e3ef6314f97a0827afa394a45c56d2f53f2b638d1efa845e828560405161047f929190610d29565b60405180910390a26104df565b3373ffffffffffffffffffffffffffffffffffffffff167f59871fd2a04a78dbcf93dd3000f85ba74bf77974cc7f2f47fdae2be66974b4308783866040516104d693929190610cf4565b60405180910390a25b505050505050565b7f000000000000000000000000000000000000000000000000000000000000000081565b6003602052805f5260405f205f91509050805f0154908060010154908060020154905083565b5f5481565b60015481565b7f0000000000000000000000000000000000000000000000000000000000000000421061059e576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016105959061101f565b60405180910390fd5b5f81116105e0576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016105d790610e1e565b60405180910390fd5b5f60035f3373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020015f20905061062981610838565b6106763330847f000000000000000000000000000000000000000000000000000000000000000073ffffffffffffffffffffffffffffffffffffffff16610a72909392919063ffffffff16565b81816001015f8282546106899190610fa2565b92505081905550815f5f8282546106a09190610fa2565b92505081905550670de0b6b3a764000060025482600101546106c29190610ed1565b6106cc9190610f3f565b81600201819055503373ffffffffffffffffffffffffffffffffffffffff167f2da466a7b24304f47e87fa2e1e5a81b9831ce54fec19055ce277ca2f39ba42c48360405161071a9190610c56565b60405180910390a25050565b5f7f00000000000000000000000000000000000000000000000000000000000000004210610756575f9050610785565b427f00000000000000000000000000000000000000000000000000000000000000006107829190610f6f565b90505b90565b7f000000000000000000000000000000000000000000000000000000000000000081565b5f5f5f60035f8573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020015f2090506107f781610af4565b815f01546108059190610fa2565b92508060010154915050915091565b7f000000000000000000000000000000000000000000000000000000000000000081565b5f61084282610af4565b90505f81111561087e578060015f82825461085d9190610f6f565b9250508190555080825f015f8282546108769190610fa2565b925050819055505b670de0b6b3a764000060025483600101546108999190610ed1565b6108a39190610f3f565b82600201819055505050565b5f815f54036108c0575f9050610923565b7f000000000000000000000000000000000000000000000000000000000000000042116108ef575f9050610923565b7f0000000000000000000000000000000000000000000000000000000000000000421061091e575f9050610923565b601490505b92915050565b5f8203156109ef575f5f5490505f826001015490505f818361094b9190610f6f565b90505f810361095c575050506109ef565b5f81670de0b6b3a7640000876109729190610ed1565b61097c9190610f3f565b90508060025f82825461098f9190610fa2565b92505081905550670de0b6b3a76400008186600101546109af9190610ed1565b6109b99190610f3f565b856002015f8282546109cb9190610fa2565b925050819055508560015f8282546109e39190610fa2565b92505081905550505050505b5050565b610a6d838473ffffffffffffffffffffffffffffffffffffffff1663a9059cbb8585604051602401610a2692919061104c565b604051602081830303815290604052915060e01b6020820180517bffffffffffffffffffffffffffffffffffffffffffffffffffffffff8381831617835250505050610b4a565b505050565b610aee848573ffffffffffffffffffffffffffffffffffffffff166323b872dd868686604051602401610aa793929190611073565b604051602081830303815290604052915060e01b6020820180517bffffffffffffffffffffffffffffffffffffffffffffffffffffffff8381831617835250505050610b4a565b50505050565b5f5f670de0b6b3a76400006002548460010154610b119190610ed1565b610b1b9190610f3f565b905082600201548111610b31575f915050610b45565b826002015481610b419190610f6f565b9150505b919050565b5f5f60205f8451602086015f885af180610b69576040513d5f823e3d81fd5b3d92505f519150505f8214610b82576001811415610b9d565b5f8473ffffffffffffffffffffffffffffffffffffffff163b145b15610bdf57836040517f5274afe7000000000000000000000000000000000000000000000000000000008152600401610bd691906110a8565b60405180910390fd5b50505050565b5f5ffd5b5f819050919050565b610bfb81610be9565b8114610c05575f5ffd5b50565b5f81359050610c1681610bf2565b92915050565b5f60208284031215610c3157610c30610be5565b5b5f610c3e84828501610c08565b91505092915050565b610c5081610be9565b82525050565b5f602082019050610c695f830184610c47565b92915050565b5f73ffffffffffffffffffffffffffffffffffffffff82169050919050565b5f610c9882610c6f565b9050919050565b610ca881610c8e565b8114610cb2575f5ffd5b50565b5f81359050610cc381610c9f565b92915050565b5f60208284031215610cde57610cdd610be5565b5b5f610ceb84828501610cb5565b91505092915050565b5f606082019050610d075f830186610c47565b610d146020830185610c47565b610d216040830184610c47565b949350505050565b5f604082019050610d3c5f830185610c47565b610d496020830184610c47565b9392505050565b5f819050919050565b5f610d73610d6e610d6984610c6f565b610d50565b610c6f565b9050919050565b5f610d8482610d59565b9050919050565b5f610d9582610d7a565b9050919050565b610da581610d8b565b82525050565b5f602082019050610dbe5f830184610d9c565b92915050565b5f82825260208201905092915050565b7f616d6f756e743d300000000000000000000000000000000000000000000000005f82015250565b5f610e08600883610dc4565b9150610e1382610dd4565b602082019050919050565b5f6020820190508181035f830152610e3581610dfc565b9050919050565b7f696e73756666696369656e74206465706f7369746564000000000000000000005f82015250565b5f610e70601683610dc4565b9150610e7b82610e3c565b602082019050919050565b5f6020820190508181035f830152610e9d81610e64565b9050919050565b7f4e487b71000000000000000000000000000000000000000000000000000000005f52601160045260245ffd5b5f610edb82610be9565b9150610ee683610be9565b9250828202610ef481610be9565b91508282048414831517610f0b57610f0a610ea4565b5b5092915050565b7f4e487b71000000000000000000000000000000000000000000000000000000005f52601260045260245ffd5b5f610f4982610be9565b9150610f5483610be9565b925082610f6457610f63610f12565b5b828204905092915050565b5f610f7982610be9565b9150610f8483610be9565b9250828203905081811115610f9c57610f9b610ea4565b5b92915050565b5f610fac82610be9565b9150610fb783610be9565b9250828201905080821115610fcf57610fce610ea4565b5b92915050565b7f456e726f6c6c6d656e7420656e646564000000000000000000000000000000005f82015250565b5f611009601083610dc4565b915061101482610fd5565b602082019050919050565b5f6020820190508181035f83015261103681610ffd565b9050919050565b61104681610c8e565b82525050565b5f60408201905061105f5f83018561103d565b61106c6020830184610c47565b9392505050565b5f6060820190506110865f83018661103d565b611093602083018561103d565b6110a06040830184610c47565b949350505050565b5f6020820190506110bb5f83018461103d565b9291505056fea264697066735822122029face10a6de798073b31d359eaaa2612e440894dbd4e3d56db3fbc1f3f55ea964736f6c634300081e0033"; /* your bytecode here */

    // --------- STATE ----------
    let provider = null;   // ethers.BrowserProvider
    let signer   = null;   // signer from wallet
    let wallet   = null;
    let currentNet = NETWORKS.sepolia; // default selection
    let dashboard = {};    // map addr -> { addr, tokenDecimals, contract, etherscanBase, interval }

    const $dash = $("#dash");

    // --------- HELPERS ----------


    async function readTokenAddr(ctr) {
      // Prefer tokenAddress() if it's in the ABI and callable
      if (typeof ctr.tokenAddress === "function") {
        try { return await ctr.tokenAddress(); } catch (_) { /* fall through */ }
      }
      // Fallback to token() if present
      if (typeof ctr.token === "function") {
        return await ctr.token();
      }
      throw new Error("Contract ABI lacks tokenAddress() and token()");
    }


    function fmtNum(x, decimals=6){
      try { return ethers.formatUnits(x ?? 0n, decimals); }
      catch { return String(x); }
    }
    function toUnits(xStr, decimals=6){
      return ethers.parseUnits(String(xStr || "0"), decimals);
    }
    function nowSec(){ return Math.floor(Date.now()/1000); }
    function fmtTs(t){
      if(!t || t==0) return "‚Äî";
      const d = new Date(Number(t) * 1000);
      return d.toLocaleString();
    }
    function updateCountdown(targetSec, el){
      if(!targetSec || targetSec==0){ el.text(""); return; }
      const diff = targetSec - nowSec();
      if(diff <= 0){ el.text("0s"); return; }
      const m = Math.floor(diff/60), s = diff%60, h = Math.floor(m/60), mm = m%60;
      el.text(diff < 3600 ? `${m}m ${s}s` : `${h}h ${mm}m`);
    }

    function addCardHtml(addr, etherscanBase){
      return `
        <div class="card" id="card-${addr.toLowerCase()}">
          <div class="flex">
            <strong class="mono">${addr}</strong>
            <span class="pill">Tontine</span>
            <a class="pill" target="_blank" href="${etherscanBase}/address/${addr}">Etherscan ‚Üó</a>
          </div>
          <div class="hr"></div>
          <div class="grid3">
            <div>
              <div class="muted">Token</div>
              <div class="mono addr" id="token-${addr}">‚Äî</div>
            </div>
            <div>
              <div class="muted">Enrollment Ends</div>
              <div id="enroll-${addr}">‚Äî</div>
              <small id="enrollCountdown-${addr}" class="muted"></small>
            </div>
            <div>
              <div class="muted">Payout Time</div>
              <div id="payout-${addr}">‚Äî</div>
              <small id="payoutCountdown-${addr}" class="muted"></small>
            </div>
          </div>

          <div class="row" style="margin-top:12px">
            <div>
              <div class="muted">Total Deposits</div>
              <div class="mono" id="tot-${addr}">‚Äî</div>
            </div>
            <div>
              <div class="muted">Fee Pool</div>
              <div class="mono" id="fee-${addr}">‚Äî</div>
            </div>
          </div>

          <div class="hr"></div>

          <div class="row">
            <div>
              <label>Your Entitlement</label>
              <div class="mono" id="ent-${addr}">‚Äî</div>
            </div>
            <div>
              <label>Your Deposited</label>
              <div class="mono" id="dep-${addr}">‚Äî</div>
            </div>
          </div>

          <div class="hr"></div>

          <div class="row">
            <div>
              <label>Amount to Deposit (tokens)</label>
              <input id="amtDep-${addr}" placeholder="e.g. 10"/>
              <div class="flex">
                <button class="btnApprove" data-addr="${addr}">Approve Token</button>
                <button class="btnDeposit" data-addr="${addr}">Deposit</button>
              </div>
            </div>
            <div>
              <label>Amount to Withdraw (tokens)</label>
              <input id="amtWdr-${addr}" placeholder="e.g. 5 (partial)"/>
              <div class="flex">
                <button class="btnWithdraw" data-addr="${addr}">Withdraw</button>
                <button class="btnWithdrawAll" data-addr="${addr}">Withdraw All</button>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    async function ensureWalletOnSelected(){
      if (!provider) return;
      const cur = await provider.send("eth_chainId", []);
      if (cur !== currentNet.chainIdHex) {
        try {
          await provider.send("wallet_switchEthereumChain", [{ chainId: currentNet.chainIdHex }]);
        } catch (e) {
          alert(`Please switch your wallet to ${currentNet.name}.`);
          throw e;
        }
      }
    }

    async function refreshOne(addr){
      const rec = dashboard[addr.toLowerCase()];
      if(!rec || !rec.contract) return;
      try{
        const [token, enrollEnd, payout, tot, fee] = await Promise.all([
          readTokenAddr(rec.contract),          // <‚Äî patched
          rec.contract.enrollmentEnd(),
          rec.contract.payoutTime(),
          rec.contract.totalDeposits(),
          rec.contract.feePool()
        ]);

        let entitlement = 0n, deposited = 0n;
        if (wallet) {
          const acct = await rec.contract.getAccount(wallet);
          entitlement = acct[0]; deposited = acct[1];
        }

        $(`#token-${addr}`).text(token);
        $(`#enroll-${addr}`).text(fmtTs(enrollEnd));
        $(`#payout-${addr}`).text(fmtTs(payout));
        updateCountdown(Number(enrollEnd), $(`#enrollCountdown-${addr}`));
        updateCountdown(Number(payout),   $(`#payoutCountdown-${addr}`));
        $(`#tot-${addr}`).text(fmtNum(tot, rec.tokenDecimals));
        $(`#fee-${addr}`).text(fmtNum(fee, rec.tokenDecimals));
        $(`#ent-${addr}`).text(fmtNum(entitlement, rec.tokenDecimals));
        $(`#dep-${addr}`).text(fmtNum(deposited, rec.tokenDecimals));
      } catch(e){
        console.error("refreshOne failed", addr, e);
      }
    }


    function startAutoRefresh(addr){
      refreshOne(addr).catch(console.error);
      const id = setInterval(() => refreshOne(addr).catch(console.error), 6000);
      dashboard[addr.toLowerCase()].interval = id;
    }

    async function addTontine(addr, tokenDecimals){
      if (!provider) return alert("Connect wallet first.");
      addr = ethers.getAddress(addr);
      const runner = signer || provider; // both support calls; signer needed for txs
      const contract = new ethers.Contract(addr, TONTINE_ABI, runner);

      dashboard[addr.toLowerCase()] = { addr, tokenDecimals, contract, etherscanBase: currentNet.etherscan };
      $dash.prepend(addCardHtml(addr, currentNet.etherscan));
      startAutoRefresh(addr);
    }

    async function autofillDecimalsForToken(addr){
      try {
        if (!provider) return; // needs wallet connection
        const erc20 = new ethers.Contract(addr, ERC20_ABI, signer || provider);
        const dec = await erc20.decimals();
        $("#inpDecimals").val(Number(dec));
      } catch (e) {
        console.warn("Could not fetch token decimals; using default.", e);
        $("#inpDecimals").val(currentNet.defaultDecimals);
      }
    }

    function setNetworkDefaults(){
      $("#inpToken").val(currentNet.defaultToken);
      $("#inpDecimals").val(currentNet.defaultDecimals);
      $("#netStatus").text(`Network: ${currentNet.name}`);
      // If already connected, try auto-fetching decimals for default token
      if (provider) autofillDecimalsForToken(currentNet.defaultToken);
    }

    // --------- UI HANDLERS ----------
    $("#btnConnect").on("click", async () => {
      if(!window.ethereum){ alert("MetaMask not found."); return; }
      await window.ethereum.request({ method: "eth_requestAccounts" });
      provider = new ethers.BrowserProvider(window.ethereum);

      await ensureWalletOnSelected();

      signer = await provider.getSigner();
      wallet = await signer.getAddress();

      $("#connStatus").text("Connected").removeClass("bad warn").addClass("ok");
      $("#netStatus").text(`Network: ${currentNet.name}`);
      $("#acct").text(wallet);

      // Autofill decimals for the current token now that we can read
      const t = $("#inpToken").val().trim();
      if (ethers.isAddress(t)) autofillDecimalsForToken(t);

      // If you had cards before connecting, rebuild their contract runners
      Object.values(dashboard).forEach(rec => {
        rec.contract = new ethers.Contract(rec.addr, TONTINE_ABI, signer || provider);
        refreshOne(rec.addr);
      });
    });

    $("#btnSwitch").on("click", async () => {
      if(!provider){ return alert("Connect wallet first."); }
      try{
        await ensureWalletOnSelected();
        $("#netStatus").text(`Network: ${currentNet.name}`);
      } catch(e){ console.error(e); }
    });

    $("#networkSelect").on("change", async function(){
      const val = $(this).val();
      currentNet = NETWORKS[val] || NETWORKS.sepolia;
      setNetworkDefaults();

      // Update Etherscan links on existing cards (view-only)
      Object.values(dashboard).forEach(rec => {
        rec.etherscanBase = currentNet.etherscan;
        const $link = $(`#card-${rec.addr.toLowerCase()} a[href*='etherscan']`);
        $link.attr('href', `${currentNet.etherscan}/address/${rec.addr}`);
      });
    });

    $("#inpToken").on("change input", function(){
      const t = $(this).val().trim();
      if (provider && ethers.isAddress(t)) autofillDecimalsForToken(t);
    });

    $("#btnDeploy").on("click", async () => {
      if(!signer) return alert("Connect wallet first.");
      if(!TONTINE_BYTECODE || TONTINE_BYTECODE === "0xYOUR_COMPILED_BYTECODE_HERE"){
        return alert("Please paste your compiled BYTECODE into the page source.");
      }
      try{ await ensureWalletOnSelected(); } catch { return; }

      const token = $("#inpToken").val().trim();
      const decimals = Number($("#inpDecimals").val());
      const enrollMin = Number($("#inpEnrollMin").val());
      const lockMin = Number($("#inpLockMin").val());
      if(!ethers.isAddress(token)) return alert("Invalid token address.");
      if(decimals < 0 || decimals > 36) return alert("Bad decimals.");

      const enrollSec = BigInt(enrollMin * 60);
      const lockSec = BigInt(lockMin * 60);

      try{
        const factory = new ethers.ContractFactory(TONTINE_ABI, TONTINE_BYTECODE, signer);
        const tx = await factory.deploy(token, enrollSec, lockSec);
        await tx.deploymentTransaction().wait();
        const addr = tx.target;
        alert("Deployed at: " + addr);
        addTontine(addr, decimals);
      }catch(e){
        console.error(e);
        alert("Deploy failed: " + (e?.shortMessage || e?.message || e));
      }
    });

    $("#btnAddExisting").on("click", async () => {
      if(!provider) return alert("Connect wallet first.");
      const addr = $("#inpExisting").val().trim();
      if(!ethers.isAddress(addr)) return alert("Invalid address.");
      try{
        // fetch token + decimals via wallet provider
        const ctr = new ethers.Contract(addr, TONTINE_ABI, signer || provider);
        const tokenAdr = await readTokenAddr(ctr);
        const erc20 = new ethers.Contract(tokenAdr, ERC20_ABI, signer || provider);
        const dec = await erc20.decimals();
        addTontine(addr, Number(dec));

      }catch(e){
        console.error(e);
        alert("Could not bind to contract‚Äîare ABI, address, and network correct?");
      }
    });

    // Dashboard buttons (txs need signer)
    $("#dash").on("click", ".btnApprove", async function(){
      const key = $(this).data("addr").toLowerCase();
      const rec = dashboard[key];
      if(!rec) return;
      if(!signer) return alert("Connect wallet first.");
      try{
        await ensureWalletOnSelected();
        const tokenAdr = await readTokenAddr(rec.contract);
        const erc20 = new ethers.Contract(tokenAdr, ERC20_ABI, signer);
        const human = $(`#amtDep-${rec.addr}`).val().trim();
        if(!human) return alert("Enter amount to approve.");
        const amount = toUnits(human, rec.tokenDecimals);
        const tx = await erc20.approve(rec.addr, amount);
        await tx.wait();
        alert("Approved " + human + " tokens for " + rec.addr);
        refreshOne(rec.addr);
      }catch(e){ console.error(e); alert("Approve failed: "+(e?.shortMessage||e?.message||e)); }
    });

    $("#dash").on("click", ".btnDeposit", async function(){
      const key = $(this).data("addr").toLowerCase();
      const rec = dashboard[key];
      if(!rec) return;
      if(!signer) return alert("Connect wallet first.");
      try{
        await ensureWalletOnSelected();
        const human = $(`#amtDep-${rec.addr}`).val().trim();
        if(!human) return alert("Enter deposit amount.");
        const amount = toUnits(human, rec.tokenDecimals);
        const tx = await rec.contract.deposit(amount);
        await tx.wait();
        alert("Deposited " + human);
        refreshOne(rec.addr);
      }catch(e){ console.error(e); alert("Deposit failed: "+(e?.shortMessage||e?.message||e)); }
    });

    $("#dash").on("click", ".btnWithdraw", async function(){
      const key = $(this).data("addr").toLowerCase();
      const rec = dashboard[key];
      if(!rec) return;
      if(!signer) return alert("Connect wallet first.");
      try{
        await ensureWalletOnSelected();
        const human = $(`#amtWdr-${rec.addr}`).val().trim();
        if(!human) return alert("Enter withdraw amount.");
        const amount = toUnits(human, rec.tokenDecimals);
        const tx = await rec.contract.withdraw(amount);
        await tx.wait();
        alert("Withdrew " + human);
        refreshOne(rec.addr);
      }catch(e){ console.error(e); alert("Withdraw failed: "+(e?.shortMessage||e?.message||e)); }
    });

    $("#dash").on("click", ".btnWithdrawAll", async function(){
      const key = $(this).data("addr").toLowerCase();
      const rec = dashboard[key];
      if(!rec) return;
      if(!signer) return alert("Connect wallet first.");
      try{
        await ensureWalletOnSelected();
        const acct = await rec.contract.getAccount(wallet);
        const deposited = acct[1];
        if (deposited === 0n) return alert("Nothing deposited.");
        const tx = await rec.contract.withdraw(deposited);
        await tx.wait();
        alert("Withdrew all");
        refreshOne(rec.addr);
      }catch(e){ console.error(e); alert("Withdraw failed: "+(e?.shortMessage||e?.message||e)); }
    });

    // --------- INIT ----------
    $(function(){
      // default to Sepolia; user can switch to Mainnet in the selector
      currentNet = NETWORKS.sepolia;
      setNetworkDefaults();
    });
  </script>
</body>
</html>

