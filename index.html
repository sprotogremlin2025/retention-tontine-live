<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>Retention Tontine ‚Äî Launcher & Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>

  <!-- jQuery + Ethers v6 -->
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.10.0/ethers.umd.min.js"></script>

  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Helvetica,Arial,sans-serif; background:#0b0f14; color:#e6edf3; margin:0; padding:24px}
    h1,h2{margin:.2rem 0}
    .card{background:#121823; border:1px solid #263241; border-radius:14px; padding:16px; margin:12px 0}
    label{display:block; margin:8px 0 4px}
    input,select,button{padding:10px; border-radius:10px; border:1px solid #2b3a4d; background:#0e141c; color:#e6edf3}
    input,select{width:100%}
    button{cursor:pointer; background:#1b2738}
    button:hover{background:#223047}
    .row{display:grid; grid-template-columns:1fr 1fr; gap:12px}
    .muted{color:#92a0b3; font-size:.9em}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace}
    .pill{display:inline-block; padding:2px 8px; border:1px solid #2b3a4d; border-radius:999px; font-size:.85em; margin-left:6px}
    .ok{color:#17d992} .warn{color:#ffcf5a} .bad{color:#ff6b6b}
    .grid3{display:grid; grid-template-columns:repeat(3,1fr); gap:12px}
    small{color:#9bb0c2}
    .flex{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
    .addr{font-size:.9em}
    .hr{height:1px; background:#263241; margin:12px 0}
    a{color:#78a6ff; text-decoration:none}
  </style>
</head>
<body>
  <h1>Retention Tontine üè¥‚Äç‚ò†Ô∏è</h1>
  <div class="muted"><i>Deploy & interact with <span class="mono">retention<a href="https://en.wikipedia.org/wiki/Tontine"> tontine</a> contracts</span> using your browser wallet.</i></div>
  <div>---------------------------------------</div>
  <div class="muted">In a traditional tontine, money is pooled among a group of people and whenever someone dies, their share is paid out to the living members of the contract. This was once a popular way to provide annuities or fund public goods like the <a href='https://en.wikipedia.org/wiki/Richmond_Bridge,_London'>Richmond Bridge</a> in London.</div>
  <div>---------------------------------------</div>
  <div class="muted">In this retention tontine, participants compete to hold assets to the end of the term. Early withdrawal pays a 20% penalty into a fee pool for remaining holders. You may withdraw penalty-free before enrollment ends; you may withdraw penalty-free if you are the "last man standing"; partial withdrawals are allowed.</div>

  <!-- Connect / Network -->
  <div class="card">
    <div class="flex" style="gap:12px; align-items:center">
      <button id="btnConnect">üîå Connect Wallet</button>
      <div id="connStatus" class="pill">Not connected</div>
      <div id="netStatus" class="pill">Network: ‚Äî</div>
      <div id="acct" class="mono addr"></div>
      <div style="margin-left:auto; min-width:220px">
        <label class="muted" style="margin:0 0 6px">Select Network</label>
        <select id="networkSelect">
          <option value="sepolia" selected>Sepolia (testnet)</option>
          <option value="mainnet">Ethereum Mainnet</option>
        </select>
      </div>
      <button id="btnSwitch">üîÑ Switch in Wallet</button>
    </div>
    <small class="muted">All reads/writes use your wallet‚Äôs provider. Connect first to see data.</small>
  </div>

  <!-- Deploy -->
  <div class="card">
    <h2>Launch New Tontine</h2>
    <div class="row">
      <div>
        <label>ERC-20 Token Address (default varies by network)</label>
        <input id="inpToken" placeholder="0x... token"/>
      </div>
      <div>
        <label>Token Decimals</label>
        <input id="inpDecimals" type="number"/>
      </div>
    </div>
    <div class="row">
      <div>
        <label>Enrollment Duration (minutes)</label>
        <input id="inpEnrollMin" type="number" value="5"/>
      </div>
      <div>
        <label>Lock Duration (minutes, starts after enrollment)</label>
        <input id="inpLockMin" type="number" value="10"/>
      </div>
    </div>
    <div class="flex">
      <button id="btnDeploy">üöÄ Deploy</button>
      <div class="muted">After deploy, the contract appears below.</div>
    </div>
  </div>

  <!-- Add existing -->
  <div class="card">
    <h2>Load Existing Tontine</h2>
    <div class="row">
      <div>
        <label>Tontine Contract Address</label>
        <input id="inpExisting" placeholder="0x... tontine contract"/>
      </div>
      <div>
        <label>&nbsp;</label>
        <button id="btnAddExisting">‚ûï Add</button>
      </div>
    </div>
  </div>

  <!-- Dashboard -->
  <div id="dash"></div>

  <!-- fun images -->
  <img src="https://s2.coinmarketcap.com/static/img/coins/200x200/25220.png">
  <img src="images/tontineart1.jpg">
  <img src="images/tontineart2.jpg">
  <img src="images/tontine3.png">

  <script>
    // --------- NETWORK CONFIG (no RPC URLs) ----------
    const NETWORKS = {
      sepolia: {
        key: 'sepolia',
        name: 'Sepolia',
        chainIdHex: '0xaa36a7',
        etherscan: 'https://sepolia.etherscan.io',
        defaultToken: '0x1c7D4B196Cb0C7B01d743Fbc6116a902379C7238', // USDC (Sepolia)
        defaultDecimals: 6
      },
      mainnet: {
        key: 'mainnet',
        name: 'Ethereum Mainnet',
        chainIdHex: '0x1',
        etherscan: 'https://etherscan.io',
        // Default to BITCOIN token on mainnet
        defaultToken: '0x72e4f9F808C49A2a61dE9C5896298920Dc4EEEa9', // BITCOIN
        defaultDecimals: 18 // will autofill from chain after connect
      }
    };

    // --------- ABIs ----------
    const ERC20_ABI = [
      "function decimals() view returns (uint8)",
      "function balanceOf(address) view returns (uint256)",
      "function allowance(address owner, address spender) view returns (uint256)",
      "function approve(address spender, uint256 amount) returns (bool)"
    ];

    const TONTINE_ABI = [
      {"inputs":[{"internalType":"address","name":"_token","type":"address"},{"internalType":"uint256","name":"_enrollmentDuration","type":"uint256"},{"internalType":"uint256","name":"_lockDuration","type":"uint256"}],"stateMutability":"nonpayable","type":"constructor"},
      {"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"Deposited","type":"event"},
      {"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"uint256","name":"shareFromPool","type":"uint256"}],"name":"FeeDistributed","type":"event"},
      {"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"uint256","name":"amountRequested","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"paidOut","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"penaltyToPool","type":"uint256"}],"name":"PartialWithdrawn","type":"event"},
      {"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"uint256","name":"paidOut","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"penaltyToPool","type":"uint256"}],"name":"WithdrawnAll","type":"event"},
      {"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"accounts","outputs":[{"internalType":"uint256","name":"entitlement","type":"uint256"},{"internalType":"uint256","name":"deposited","type":"uint256"}],"stateMutability":"view","type":"function"},
      {"inputs":[{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"deposit","outputs":[],"stateMutability":"nonpayable","type":"function"},
      {"inputs":[],"name":"enrollmentEnd","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
      {"inputs":[],"name":"feePool","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
      {"inputs":[{"internalType":"address","name":"user","type":"address"}],"name":"getAccount","outputs":[{"internalType":"uint256","name":"entitlement","type":"uint256"},{"internalType":"uint256","name":"deposited","type":"uint256"}],"stateMutability":"view","type":"function"},
      {"inputs":[],"name":"payoutTime","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
      {"inputs":[],"name":"timeUntilPayout","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
      {"inputs":[],"name":"token","outputs":[{"internalType":"contract IERC20","name":"","type":"address"}],"stateMutability":"view","type":"function"},
      {"inputs":[],"name":"tokenAddress","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},
      {"inputs":[],"name":"totalDeposits","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
      {"inputs":[{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"withdraw","outputs":[],"stateMutability":"nonpayable","type":"function"}
    ];

    // If you deploy from the UI, paste your bytecode (unchanged)
    const TONTINE_BYTECODE = "60e060405260015f55348015610013575f5ffd5b506040516115793803806115798339818101604052810190610035919061019b565b5f73ffffffffffffffffffffffffffffffffffffffff168373ffffffffffffffffffffffffffffffffffffffff16036100a3576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161009a90610245565b60405180910390fd5b8273ffffffffffffffffffffffffffffffffffffffff1660808173ffffffffffffffffffffffffffffffffffffffff16815250505f82426100e49190610290565b90508060a0818152505081816100fa9190610290565b60c08181525050505050506102c3565b5f5ffd5b5f73ffffffffffffffffffffffffffffffffffffffff82169050919050565b5f6101378261010e565b9050919050565b6101478161012d565b8114610151575f5ffd5b50565b5f815190506101628161013e565b92915050565b5f819050919050565b61017a81610168565b8114610184575f5ffd5b50565b5f8151905061019581610171565b92915050565b5f5f5f606084860312156101b2576101b161010a565b5b5f6101bf86828701610154565b93505060206101d086828701610187565b92505060406101e186828701610187565b9150509250925092565b5f82825260208201905092915050565b7f746f6b656e3d30000000000000000000000000000000000000000000000000005f82015250565b5f61022f6007836101eb565b915061023a826101fb565b602082019050919050565b5f6020820190508181035f83015261025c81610223565b9050919050565b7f4e487b71000000000000000000000000000000000000000000000000000000005f52601160045260245ffd5b5f61029a82610168565b91506102a583610168565b92508282019050808211156102bd576102bc610263565b5b92915050565b60805160a05160c0516112546103255f395f81816104c60152818161086b0152818161089b01526108cc01525f81816104960152818161061501526106d701525f818161066001528181610945015281816109720152610a5e01526112545ff3fe608060405234801561000f575f5ffd5b50600436106100a7575f3560e01c8063ae2e933b1161006f578063ae2e933b14610152578063b6b55f2514610170578063c4df0c091461018c578063ed5f41ff146101aa578063fbcbc0f1146101c8578063fc0c546a146101f9576100a7565b80632e1a7d4d146100ab5780634a5b5a8a146100c75780635e5c06e2146100e55780637d882097146101165780639d76ea5814610134575b5f5ffd5b6100c560048036038101906100c09190610b79565b610217565b005b6100cf610613565b6040516100dc9190610bb3565b60405180910390f35b6100ff60048036038101906100fa9190610c26565b610637565b60405161010d929190610c51565b60405180910390f35b61011e610657565b60405161012b9190610bb3565b60405180910390f35b61013c61065d565b6040516101499190610c87565b60405180910390f35b61015a610684565b6040516101679190610bb3565b60405180910390f35b61018a60048036038101906101859190610b79565b61068a565b005b610194610868565b6040516101a19190610bb3565b60405180910390f35b6101b26108ca565b6040516101bf9190610bb3565b60405180910390f35b6101e260048036038101906101dd9190610c26565b6108ee565b6040516101f0929190610c51565b60405180910390f35b610201610943565b60405161020e9190610cfb565b60405180910390f35b60015f541461025b576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161025290610d6e565b60405180910390fd5b60025f819055505f81116102a4576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161029b90610dd6565b60405180910390fd5b5f60015f3373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020015f2090505f816001015490508281101561032f576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161032690610e3e565b60405180910390fd5b826003541015610374576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161036b90610ea6565b60405180910390fd5b5f5f90505f600254111561042857600354600254856103939190610ef1565b61039d9190610f5f565b90505f8111156104275780835f015f8282546103b99190610f8f565b925050819055508060025f8282546103d19190610fc2565b925050819055503373ffffffffffffffffffffffffffffffffffffffff167f6c461460f28af1386f23dc4c0c7f4e2e54f0db320a8edc08803e4b787f6db3258260405161041e9190610bb3565b60405180910390a25b5b5f8285855f01546104399190610ef1565b6104439190610f5f565b905084836104519190610fc2565b846001018190555080845f015f82825461046b9190610fc2565b925050819055508460035f8282546104839190610fc2565b925050819055505f5f6003541490505f5f7f00000000000000000000000000000000000000000000000000000000000000004210156104c457839150610545565b7f000000000000000000000000000000000000000000000000000000000000000042106104f357839150610544565b821561050157839150610543565b60056004856105109190610ef1565b61051a9190610f5f565b915081846105289190610fc2565b90508060025f82825461053b9190610f8f565b925050819055505b5b5b61054f3383610967565b5f8760010154036105af573373ffffffffffffffffffffffffffffffffffffffff167f8f420e722d4b21a3e3ef6314f97a0827afa394a45c56d2f53f2b638d1efa845e83836040516105a2929190610c51565b60405180910390a2610602565b3373ffffffffffffffffffffffffffffffffffffffff167f59871fd2a04a78dbcf93dd3000f85ba74bf77974cc7f2f47fdae2be66974b4308984846040516105f993929190610ff5565b60405180910390a25b5050505050505060015f8190555050565b7f000000000000000000000000000000000000000000000000000000000000000081565b6001602052805f5260405f205f91509050805f0154908060010154905082565b60035481565b5f7f0000000000000000000000000000000000000000000000000000000000000000905090565b60025481565b60015f54146106ce576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016106c590610d6e565b60405180910390fd5b60025f819055507f00000000000000000000000000000000000000000000000000000000000000004210610737576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161072e90611074565b60405180910390fd5b5f8111610779576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161077090610dd6565b60405180910390fd5b610784333083610a53565b5f60015f3373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020015f20905081816001015f8282546107d79190610f8f565b9250508190555081815f015f8282546107f09190610f8f565b925050819055508160035f8282546108089190610f8f565b925050819055503373ffffffffffffffffffffffffffffffffffffffff167f2da466a7b24304f47e87fa2e1e5a81b9831ce54fec19055ce277ca2f39ba42c4836040516108559190610bb3565b60405180910390a25060015f8190555050565b5f7f00000000000000000000000000000000000000000000000000000000000000004210610898575f90506108c7565b427f00000000000000000000000000000000000000000000000000000000000000006108c49190610fc2565b90505b90565b7f000000000000000000000000000000000000000000000000000000000000000081565b5f5f5f60015f8573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020015f209050805f015481600101549250925050915091565b7f000000000000000000000000000000000000000000000000000000000000000081565b5f810315610a4f575f7f000000000000000000000000000000000000000000000000000000000000000073ffffffffffffffffffffffffffffffffffffffff1663a9059cbb84846040518363ffffffff1660e01b81526004016109cb929190611092565b6020604051808303815f875af11580156109e7573d5f5f3e3d5ffd5b505050506040513d601f19601f82011682018060405250810190610a0b91906110ee565b905080610a4d576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401610a4490611163565b60405180910390fd5b505b5050565b5f810315610b3d575f7f000000000000000000000000000000000000000000000000000000000000000073ffffffffffffffffffffffffffffffffffffffff166323b872dd8585856040518463ffffffff1660e01b8152600401610ab993929190611181565b6020604051808303815f875af1158015610ad5573d5f5f3e3d5ffd5b505050506040513d601f19601f82011682018060405250810190610af991906110ee565b905080610b3b576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401610b3290611200565b60405180910390fd5b505b505050565b5f5ffd5b5f819050919050565b610b5881610b46565b8114610b62575f5ffd5b50565b5f81359050610b7381610b4f565b92915050565b5f60208284031215610b8e57610b8d610b42565b5b5f610b9b84828501610b65565b91505092915050565b610bad81610b46565b82525050565b5f602082019050610bc65f830184610ba4565b92915050565b5f73ffffffffffffffffffffffffffffffffffffffff82169050919050565b5f610bf582610bcc565b9050919050565b610c0581610beb565b8114610c0f575f5ffd5b50565b5f81359050610c2081610bfc565b92915050565b5f60208284031215610c3b57610c3a610b42565b5b5f610c4884828501610c12565b91505092915050565b5f604082019050610c645f830185610ba4565b610c716020830184610ba4565b9392505050565b610c8181610beb565b82525050565b5f602082019050610c9a5f830184610c78565b92915050565b5f819050919050565b5f610cc3610cbe610cb984610bcc565b610ca0565b610bcc565b9050919050565b5f610cd482610ca9565b9050919050565b5f610ce582610cca565b9050919050565b610cf581610cdb565b82525050565b5f602082019050610d0e5f830184610cec565b92915050565b5f82825260208201905092915050565b7f5265656e7472616e637947756172643a207265656e7472616e740000000000005f82015250565b5f610d58601a83610d14565b9150610d6382610d24565b602082019050919050565b5f6020820190508181035f830152610d8581610d4c565b9050919050565b7f616d6f756e743d300000000000000000000000000000000000000000000000005f82015250565b5f610dc0600883610d14565b9150610dcb82610d8c565b602082019050919050565b5f6020820190508181035f830152610ded81610db4565b9050919050565b7f696e73756666696369656e74206465706f7369746564000000000000000000005f82015250565b5f610e28601683610d14565b9150610e3382610df4565b602082019050919050565b5f6020820190508181035f830152610e5581610e1c565b9050919050565b7f706f6f6c206163636f756e74696e67206572726f7200000000000000000000005f82015250565b5f610e90601583610d14565b9150610e9b82610e5c565b602082019050919050565b5f6020820190508181035f830152610ebd81610e84565b9050919050565b7f4e487b71000000000000000000000000000000000000000000000000000000005f52601160045260245ffd5b5f610efb82610b46565b9150610f0683610b46565b9250828202610f1481610b46565b91508282048414831517610f2b57610f2a610ec4565b5b5092915050565b7f4e487b71000000000000000000000000000000000000000000000000000000005f52601260045260245ffd5b5f610f6982610b46565b9150610f7483610b46565b925082610f8457610f83610f32565b5b828204905092915050565b5f610f9982610b46565b9150610fa483610b46565b9250828201905080821115610fbc57610fbb610ec4565b5b92915050565b5f610fcc82610b46565b9150610fd783610b46565b9250828203905081811115610fef57610fee610ec4565b5b92915050565b5f6060820190506110085f830186610ba4565b6110156020830185610ba4565b6110226040830184610ba4565b949350505050565b7f456e726f6c6c6d656e7420656e646564000000000000000000000000000000005f82015250565b5f61105e601083610d14565b91506110698261102a565b602082019050919050565b5f6020820190508181035f83015261108b81611052565b9050919050565b5f6040820190506110a55f830185610c78565b6110b26020830184610ba4565b9392505050565b5f8115159050919050565b6110cd816110b9565b81146110d7575f5ffd5b50565b5f815190506110e8816110c4565b92915050565b5f6020828403121561110357611102610b42565b5b5f611110848285016110da565b91505092915050565b7f7472616e73666572206661696c656400000000000000000000000000000000005f82015250565b5f61114d600f83610d14565b915061115882611119565b602082019050919050565b5f6020820190508181035f83015261117a81611141565b9050919050565b5f6060820190506111945f830186610c78565b6111a16020830185610c78565b6111ae6040830184610ba4565b949350505050565b7f7472616e7366657246726f6d206661696c6564000000000000000000000000005f82015250565b5f6111ea601383610d14565b91506111f5826111b6565b602082019050919050565b5f6020820190508181035f830152611217816111de565b905091905056fea26469706673582212204a6bd000cfde33c056af6d3d1e39c305826bff8de7ada00a6e9a0afd74262ea164736f6c634300081e0033" /* your bytecode here */;

    // --------- STATE ----------
    let provider = null;   // ethers.BrowserProvider
    let signer   = null;   // signer from wallet
    let wallet   = null;
    let currentNet = NETWORKS.sepolia; // default selection
    let dashboard = {};    // map addr -> { addr, tokenDecimals, contract, etherscanBase, interval }

    const $dash = $("#dash");

    // --------- HELPERS ----------
    function fmtNum(x, decimals=6){
      try { return ethers.formatUnits(x ?? 0n, decimals); }
      catch { return String(x); }
    }
    function toUnits(xStr, decimals=6){
      return ethers.parseUnits(String(xStr || "0"), decimals);
    }
    function nowSec(){ return Math.floor(Date.now()/1000); }
    function fmtTs(t){
      if(!t || t==0) return "‚Äî";
      const d = new Date(Number(t) * 1000);
      return d.toLocaleString();
    }
    function updateCountdown(targetSec, el){
      if(!targetSec || targetSec==0){ el.text(""); return; }
      const diff = targetSec - nowSec();
      if(diff <= 0){ el.text("0s"); return; }
      const m = Math.floor(diff/60), s = diff%60, h = Math.floor(m/60), mm = m%60;
      el.text(diff < 3600 ? `${m}m ${s}s` : `${h}h ${mm}m`);
    }

    function addCardHtml(addr, etherscanBase){
      return `
        <div class="card" id="card-${addr.toLowerCase()}">
          <div class="flex">
            <strong class="mono">${addr}</strong>
            <span class="pill">Tontine</span>
            <a class="pill" target="_blank" href="${etherscanBase}/address/${addr}">Etherscan ‚Üó</a>
          </div>
          <div class="hr"></div>
          <div class="grid3">
            <div>
              <div class="muted">Token</div>
              <div class="mono addr" id="token-${addr}">‚Äî</div>
            </div>
            <div>
              <div class="muted">Enrollment Ends</div>
              <div id="enroll-${addr}">‚Äî</div>
              <small id="enrollCountdown-${addr}" class="muted"></small>
            </div>
            <div>
              <div class="muted">Payout Time</div>
              <div id="payout-${addr}">‚Äî</div>
              <small id="payoutCountdown-${addr}" class="muted"></small>
            </div>
          </div>

          <div class="row" style="margin-top:12px">
            <div>
              <div class="muted">Total Deposits</div>
              <div class="mono" id="tot-${addr}">‚Äî</div>
            </div>
            <div>
              <div class="muted">Fee Pool</div>
              <div class="mono" id="fee-${addr}">‚Äî</div>
            </div>
          </div>

          <div class="hr"></div>

          <div class="row">
            <div>
              <label>Your Entitlement</label>
              <div class="mono" id="ent-${addr}">‚Äî</div>
            </div>
            <div>
              <label>Your Deposited</label>
              <div class="mono" id="dep-${addr}">‚Äî</div>
            </div>
          </div>

          <div class="hr"></div>

          <div class="row">
            <div>
              <label>Amount to Deposit (tokens)</label>
              <input id="amtDep-${addr}" placeholder="e.g. 10"/>
              <div class="flex">
                <button class="btnApprove" data-addr="${addr}">Approve Token</button>
                <button class="btnDeposit" data-addr="${addr}">Deposit</button>
              </div>
            </div>
            <div>
              <label>Amount to Withdraw (tokens)</label>
              <input id="amtWdr-${addr}" placeholder="e.g. 5 (partial)"/>
              <div class="flex">
                <button class="btnWithdraw" data-addr="${addr}">Withdraw</button>
                <button class="btnWithdrawAll" data-addr="${addr}">Withdraw All</button>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    async function ensureWalletOnSelected(){
      if (!provider) return;
      const cur = await provider.send("eth_chainId", []);
      if (cur !== currentNet.chainIdHex) {
        try {
          await provider.send("wallet_switchEthereumChain", [{ chainId: currentNet.chainIdHex }]);
        } catch (e) {
          alert(`Please switch your wallet to ${currentNet.name}.`);
          throw e;
        }
      }
    }

    async function refreshOne(addr){
      const rec = dashboard[addr.toLowerCase()];
      if(!rec || !rec.contract) return;
      try{
        const [token, enrollEnd, payout, tot, fee] = await Promise.all([
          rec.contract.tokenAddress(),
          rec.contract.enrollmentEnd(),
          rec.contract.payoutTime(),
          rec.contract.totalDeposits(),
          rec.contract.feePool()
        ]);

        let entitlement = 0n, deposited = 0n;
        if (wallet) {
          const acct = await rec.contract.getAccount(wallet);
          entitlement = acct[0]; deposited = acct[1];
        }

        $(`#token-${addr}`).text(token);
        $(`#enroll-${addr}`).text(fmtTs(enrollEnd));
        $(`#payout-${addr}`).text(fmtTs(payout));
        updateCountdown(Number(enrollEnd), $(`#enrollCountdown-${addr}`));
        updateCountdown(Number(payout),   $(`#payoutCountdown-${addr}`));
        $(`#tot-${addr}`).text(fmtNum(tot, rec.tokenDecimals));
        $(`#fee-${addr}`).text(fmtNum(fee, rec.tokenDecimals));
        $(`#ent-${addr}`).text(fmtNum(entitlement, rec.tokenDecimals));
        $(`#dep-${addr}`).text(fmtNum(deposited, rec.tokenDecimals));
      } catch(e){
        console.error("refreshOne failed", addr, e);
      }
    }

    function startAutoRefresh(addr){
      refreshOne(addr).catch(console.error);
      const id = setInterval(() => refreshOne(addr).catch(console.error), 6000);
      dashboard[addr.toLowerCase()].interval = id;
    }

    async function addTontine(addr, tokenDecimals){
      if (!provider) return alert("Connect wallet first.");
      addr = ethers.getAddress(addr);
      const runner = signer || provider; // both support calls; signer needed for txs
      const contract = new ethers.Contract(addr, TONTINE_ABI, runner);

      dashboard[addr.toLowerCase()] = { addr, tokenDecimals, contract, etherscanBase: currentNet.etherscan };
      $dash.prepend(addCardHtml(addr, currentNet.etherscan));
      startAutoRefresh(addr);
    }

    async function autofillDecimalsForToken(addr){
      try {
        if (!provider) return; // needs wallet connection
        const erc20 = new ethers.Contract(addr, ERC20_ABI, signer || provider);
        const dec = await erc20.decimals();
        $("#inpDecimals").val(Number(dec));
      } catch (e) {
        console.warn("Could not fetch token decimals; using default.", e);
        $("#inpDecimals").val(currentNet.defaultDecimals);
      }
    }

    function setNetworkDefaults(){
      $("#inpToken").val(currentNet.defaultToken);
      $("#inpDecimals").val(currentNet.defaultDecimals);
      $("#netStatus").text(`Network: ${currentNet.name}`);
      // If already connected, try auto-fetching decimals for default token
      if (provider) autofillDecimalsForToken(currentNet.defaultToken);
    }

    // --------- UI HANDLERS ----------
    $("#btnConnect").on("click", async () => {
      if(!window.ethereum){ alert("MetaMask not found."); return; }
      await window.ethereum.request({ method: "eth_requestAccounts" });
      provider = new ethers.BrowserProvider(window.ethereum);

      await ensureWalletOnSelected();

      signer = await provider.getSigner();
      wallet = await signer.getAddress();

      $("#connStatus").text("Connected").removeClass("bad warn").addClass("ok");
      $("#netStatus").text(`Network: ${currentNet.name}`);
      $("#acct").text(wallet);

      // Autofill decimals for the current token now that we can read
      const t = $("#inpToken").val().trim();
      if (ethers.isAddress(t)) autofillDecimalsForToken(t);

      // If you had cards before connecting, rebuild their contract runners
      Object.values(dashboard).forEach(rec => {
        rec.contract = new ethers.Contract(rec.addr, TONTINE_ABI, signer || provider);
        refreshOne(rec.addr);
      });
    });

    $("#btnSwitch").on("click", async () => {
      if(!provider){ return alert("Connect wallet first."); }
      try{
        await ensureWalletOnSelected();
        $("#netStatus").text(`Network: ${currentNet.name}`);
      } catch(e){ console.error(e); }
    });

    $("#networkSelect").on("change", async function(){
      const val = $(this).val();
      currentNet = NETWORKS[val] || NETWORKS.sepolia;
      setNetworkDefaults();

      // Update Etherscan links on existing cards (view-only)
      Object.values(dashboard).forEach(rec => {
        rec.etherscanBase = currentNet.etherscan;
        const $link = $(`#card-${rec.addr.toLowerCase()} a[href*='etherscan']`);
        $link.attr('href', `${currentNet.etherscan}/address/${rec.addr}`);
      });
    });

    $("#inpToken").on("change input", function(){
      const t = $(this).val().trim();
      if (provider && ethers.isAddress(t)) autofillDecimalsForToken(t);
    });

    $("#btnDeploy").on("click", async () => {
      if(!signer) return alert("Connect wallet first.");
      if(!TONTINE_BYTECODE || TONTINE_BYTECODE === "0xYOUR_COMPILED_BYTECODE_HERE"){
        return alert("Please paste your compiled BYTECODE into the page source.");
      }
      try{ await ensureWalletOnSelected(); } catch { return; }

      const token = $("#inpToken").val().trim();
      const decimals = Number($("#inpDecimals").val());
      const enrollMin = Number($("#inpEnrollMin").val());
      const lockMin = Number($("#inpLockMin").val());
      if(!ethers.isAddress(token)) return alert("Invalid token address.");
      if(decimals < 0 || decimals > 36) return alert("Bad decimals.");

      const enrollSec = BigInt(enrollMin * 60);
      const lockSec = BigInt(lockMin * 60);

      try{
        const factory = new ethers.ContractFactory(TONTINE_ABI, TONTINE_BYTECODE, signer);
        const tx = await factory.deploy(token, enrollSec, lockSec);
        await tx.deploymentTransaction().wait();
        const addr = tx.target;
        alert("Deployed at: " + addr);
        addTontine(addr, decimals);
      }catch(e){
        console.error(e);
        alert("Deploy failed: " + (e?.shortMessage || e?.message || e));
      }
    });

    $("#btnAddExisting").on("click", async () => {
      if(!provider) return alert("Connect wallet first.");
      const addr = $("#inpExisting").val().trim();
      if(!ethers.isAddress(addr)) return alert("Invalid address.");
      try{
        // fetch token + decimals via wallet provider
        const ctr = new ethers.Contract(addr, TONTINE_ABI, signer || provider);
        const tokenAdr = await ctr.tokenAddress();
        const erc20 = new ethers.Contract(tokenAdr, ERC20_ABI, signer || provider);
        const dec = await erc20.decimals();
        addTontine(addr, Number(dec));
      }catch(e){
        console.error(e);
        alert("Could not bind to contract‚Äîare ABI, address, and network correct?");
      }
    });

    // Dashboard buttons (txs need signer)
    $("#dash").on("click", ".btnApprove", async function(){
      const key = $(this).data("addr").toLowerCase();
      const rec = dashboard[key];
      if(!rec) return;
      if(!signer) return alert("Connect wallet first.");
      try{
        await ensureWalletOnSelected();
        const tokenAdr = await rec.contract.tokenAddress();
        const erc20 = new ethers.Contract(tokenAdr, ERC20_ABI, signer);
        const human = $(`#amtDep-${rec.addr}`).val().trim();
        if(!human) return alert("Enter amount to approve.");
        const amount = toUnits(human, rec.tokenDecimals);
        const tx = await erc20.approve(rec.addr, amount);
        await tx.wait();
        alert("Approved " + human + " tokens for " + rec.addr);
        refreshOne(rec.addr);
      }catch(e){ console.error(e); alert("Approve failed: "+(e?.shortMessage||e?.message||e)); }
    });

    $("#dash").on("click", ".btnDeposit", async function(){
      const key = $(this).data("addr").toLowerCase();
      const rec = dashboard[key];
      if(!rec) return;
      if(!signer) return alert("Connect wallet first.");
      try{
        await ensureWalletOnSelected();
        const human = $(`#amtDep-${rec.addr}`).val().trim();
        if(!human) return alert("Enter deposit amount.");
        const amount = toUnits(human, rec.tokenDecimals);
        const tx = await rec.contract.deposit(amount);
        await tx.wait();
        alert("Deposited " + human);
        refreshOne(rec.addr);
      }catch(e){ console.error(e); alert("Deposit failed: "+(e?.shortMessage||e?.message||e)); }
    });

    $("#dash").on("click", ".btnWithdraw", async function(){
      const key = $(this).data("addr").toLowerCase();
      const rec = dashboard[key];
      if(!rec) return;
      if(!signer) return alert("Connect wallet first.");
      try{
        await ensureWalletOnSelected();
        const human = $(`#amtWdr-${rec.addr}`).val().trim();
        if(!human) return alert("Enter withdraw amount.");
        const amount = toUnits(human, rec.tokenDecimals);
        const tx = await rec.contract.withdraw(amount);
        await tx.wait();
        alert("Withdrew " + human);
        refreshOne(rec.addr);
      }catch(e){ console.error(e); alert("Withdraw failed: "+(e?.shortMessage||e?.message||e)); }
    });

    $("#dash").on("click", ".btnWithdrawAll", async function(){
      const key = $(this).data("addr").toLowerCase();
      const rec = dashboard[key];
      if(!rec) return;
      if(!signer) return alert("Connect wallet first.");
      try{
        await ensureWalletOnSelected();
        const acct = await rec.contract.getAccount(wallet);
        const deposited = acct[1];
        if (deposited === 0n) return alert("Nothing deposited.");
        const tx = await rec.contract.withdraw(deposited);
        await tx.wait();
        alert("Withdrew all");
        refreshOne(rec.addr);
      }catch(e){ console.error(e); alert("Withdraw failed: "+(e?.shortMessage||e?.message||e)); }
    });

    // --------- INIT ----------
    $(function(){
      // default to Sepolia; user can switch to Mainnet in the selector
      currentNet = NETWORKS.sepolia;
      setNetworkDefaults();
    });
  </script>
</body>
</html>

