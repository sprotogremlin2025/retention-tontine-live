<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>Retention Tontine ‚Äî Launcher & Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>

  <!-- jQuery + Ethers v6 -->
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.10.0/ethers.umd.min.js"></script>

  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Helvetica,Arial,sans-serif; background:#0b0f14; color:#e6edf3; margin:0; padding:24px}
    h1,h2{margin:.2rem 0}
    .card{background:#121823; border:1px solid #263241; border-radius:14px; padding:16px; margin:12px 0}
    label{display:block; margin:8px 0 4px}
    input,select,button{padding:10px; border-radius:10px; border:1px solid #2b3a4d; background:#0e141c; color:#e6edf3}
    input,select{width:100%}
    button{cursor:pointer; background:#1b2738}
    button:hover{background:#223047}
    .row{display:grid; grid-template-columns:1fr 1fr; gap:12px}
    .muted{color:#92a0b3; font-size:.9em}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace}
    .pill{display:inline-block; padding:2px 8px; border:1px solid #2b3a4d; border-radius:999px; font-size:.85em; margin-left:6px}
    .ok{color:#17d992} .warn{color:#ffcf5a} .bad{color:#ff6b6b}
    .grid3{display:grid; grid-template-columns:repeat(3,1fr); gap:12px}
    small{color:#9bb0c2}
    .flex{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
    .addr{font-size:.9em}
    .hr{height:1px; background:#263241; margin:12px 0}
    a{color:#78a6ff; text-decoration:none}
  </style>
</head>
<body>
  <h1>Retention Tontine üè¥‚Äç‚ò†Ô∏è</h1>
  <div class="muted"><i>Deploy & interact with <span class="mono">retention<a href="https://en.wikipedia.org/wiki/Tontine"> tontine</a> contracts</span> using your browser wallet.</i></div>
  <div>---------------------------------------</div>
  <div class="muted">In a traditional tontine, money is pooled among a group of people and whenever someone dies, their share is paid out to the living members of the contract. This was once a popular way to provide annuities or fund public goods like the <a href='https://en.wikipedia.org/wiki/Richmond_Bridge,_London'>Richmond Bridge</a> in London.</div>
  <div>---------------------------------------</div>
  <div class="muted">In this retention tontine, participants compete to hold assets to the end of the term. Early withdrawal pays a 20% penalty into a fee pool for remaining holders. You may withdraw penalty-free before enrollment ends; you may withdraw penalty-free if you are the "last man standing"; partial withdrawals are allowed.</div>

  <!-- Connect / Network -->
  <div class="card">
    <div class="flex" style="gap:12px; align-items:center">
      <button id="btnConnect">üîå Connect Wallet</button>
      <div id="connStatus" class="pill">Not connected</div>
      <div id="netStatus" class="pill">Network: ‚Äî</div>
      <div id="acct" class="mono addr"></div>
      <div style="margin-left:auto; min-width:220px">
        <label class="muted" style="margin:0 0 6px">Select Network</label>
        <select id="networkSelect">
          <option value="sepolia" selected>Sepolia (testnet)</option>
          <option value="mainnet">Ethereum Mainnet</option>
        </select>
      </div>
      <button id="btnSwitch">üîÑ Switch in Wallet</button>
    </div>
    <small class="muted">All reads/writes use your wallet‚Äôs provider. Connect first to see data.</small>
  </div>

  <!-- Deploy -->
  <div class="card">
    <h2>Launch New Tontine</h2>
    <div class="row">
      <div>
        <label>ERC-20 Token Address (default varies by network)</label>
        <input id="inpToken" placeholder="0x... token"/>
      </div>
      <div>
        <label>Token Decimals</label>
        <input id="inpDecimals" type="number"/>
      </div>
    </div>
    <div class="row">
      <div>
        <label>Enrollment Duration (minutes)</label>
        <input id="inpEnrollMin" type="number" value="5"/>
      </div>
      <div>
        <label>Lock Duration (minutes, starts after enrollment)</label>
        <input id="inpLockMin" type="number" value="10"/>
      </div>
    </div>
    <div class="flex">
      <button id="btnDeploy">üöÄ Deploy</button>
      <div class="muted">After deploy, the contract appears below.</div>
    </div>
  </div>

  <!-- Add existing -->
  <div class="card">
    <h2>Load Existing Tontine</h2>
    <div class="row">
      <div>
        <label>Tontine Contract Address</label>
        <input id="inpExisting" placeholder="0x... tontine contract"/>
      </div>
      <div>
        <label>&nbsp;</label>
        <button id="btnAddExisting">‚ûï Add</button>
      </div>
    </div>
  </div>

  <!-- Dashboard -->
  <div id="dash"></div>

  <!-- fun images -->
  <img src="https://s2.coinmarketcap.com/static/img/coins/200x200/25220.png">
  <img src="images/tontineart1.jpg">
  <img src="images/tontineart2.jpg">
  <img src="images/tontine3.png">

  <script>
    // --------- NETWORK CONFIG (no RPC URLs) ----------
    const NETWORKS = {
      sepolia: {
        key: 'sepolia',
        name: 'Sepolia',
        chainIdHex: '0xaa36a7',
        etherscan: 'https://sepolia.etherscan.io',
        defaultToken: '0x1c7D4B196Cb0C7B01d743Fbc6116a902379C7238', // USDC (Sepolia)
        defaultDecimals: 6
      },
      mainnet: {
        key: 'mainnet',
        name: 'Ethereum Mainnet',
        chainIdHex: '0x1',
        etherscan: 'https://etherscan.io',
        // Default to BITCOIN token on mainnet
        defaultToken: '0x72e4f9F808C49A2a61dE9C5896298920Dc4EEEa9', // BITCOIN
        defaultDecimals: 18 // will autofill from chain after connect
      }
    };

    // --------- ABIs ----------
    const ERC20_ABI = [
      "function decimals() view returns (uint8)",
      "function balanceOf(address) view returns (uint256)",
      "function allowance(address owner, address spender) view returns (uint256)",
      "function approve(address spender, uint256 amount) returns (bool)"
    ];

    const TONTINE_ABI = [
           
        {
          "inputs": [
            {
              "internalType": "address",
              "name": "_token",
              "type": "address"
            },
            {
              "internalType": "uint256",
              "name": "_enrollmentDuration",
              "type": "uint256"
            },
            {
              "internalType": "uint256",
              "name": "_lockDuration",
              "type": "uint256"
            }
          ],
          "stateMutability": "nonpayable",
          "type": "constructor"
        },
        {
          "inputs": [
            {
              "internalType": "address",
              "name": "token",
              "type": "address"
            }
          ],
          "name": "SafeERC20FailedOperation",
          "type": "error"
        },
        {
          "anonymous": false,
          "inputs": [
            {
              "indexed": true,
              "internalType": "address",
              "name": "user",
              "type": "address"
            },
            {
              "indexed": false,
              "internalType": "uint256",
              "name": "amount",
              "type": "uint256"
            }
          ],
          "name": "Deposited",
          "type": "event"
        },
        {
          "anonymous": false,
          "inputs": [
            {
              "indexed": true,
              "internalType": "address",
              "name": "user",
              "type": "address"
            },
            {
              "indexed": false,
              "internalType": "uint256",
              "name": "shareFromPool",
              "type": "uint256"
            }
          ],
          "name": "FeeDistributed",
          "type": "event"
        },
        {
          "anonymous": false,
          "inputs": [
            {
              "indexed": true,
              "internalType": "address",
              "name": "user",
              "type": "address"
            },
            {
              "indexed": false,
              "internalType": "uint256",
              "name": "amountRequested",
              "type": "uint256"
            },
            {
              "indexed": false,
              "internalType": "uint256",
              "name": "paidOut",
              "type": "uint256"
            },
            {
              "indexed": false,
              "internalType": "uint256",
              "name": "penaltyToPool",
              "type": "uint256"
            }
          ],
          "name": "PartialWithdrawn",
          "type": "event"
        },
        {
          "anonymous": false,
          "inputs": [
            {
              "indexed": true,
              "internalType": "address",
              "name": "user",
              "type": "address"
            },
            {
              "indexed": false,
              "internalType": "uint256",
              "name": "paidOut",
              "type": "uint256"
            },
            {
              "indexed": false,
              "internalType": "uint256",
              "name": "penaltyToPool",
              "type": "uint256"
            }
          ],
          "name": "WithdrawnAll",
          "type": "event"
        },
        {
          "inputs": [
            {
              "internalType": "address",
              "name": "",
              "type": "address"
            }
          ],
          "name": "accounts",
          "outputs": [
            {
              "internalType": "uint256",
              "name": "entitlement",
              "type": "uint256"
            },
            {
              "internalType": "uint256",
              "name": "deposited",
              "type": "uint256"
            },
            {
              "internalType": "uint256",
              "name": "rewardDebt",
              "type": "uint256"
            }
          ],
          "stateMutability": "view",
          "type": "function"
        },
        {
          "inputs": [
            {
              "internalType": "uint256",
              "name": "amount",
              "type": "uint256"
            }
          ],
          "name": "deposit",
          "outputs": [],
          "stateMutability": "nonpayable",
          "type": "function"
        },
        {
          "inputs": [],
          "name": "enrollmentEnd",
          "outputs": [
            {
              "internalType": "uint256",
              "name": "",
              "type": "uint256"
            }
          ],
          "stateMutability": "view",
          "type": "function"
        },
        {
          "inputs": [],
          "name": "feePool",
          "outputs": [
            {
              "internalType": "uint256",
              "name": "",
              "type": "uint256"
            }
          ],
          "stateMutability": "view",
          "type": "function"
        },
        {
          "inputs": [
            {
              "internalType": "address",
              "name": "user",
              "type": "address"
            }
          ],
          "name": "getAccount",
          "outputs": [
            {
              "internalType": "uint256",
              "name": "entitlement",
              "type": "uint256"
            },
            {
              "internalType": "uint256",
              "name": "deposited",
              "type": "uint256"
            }
          ],
          "stateMutability": "view",
          "type": "function"
        },
        {
          "inputs": [],
          "name": "payoutTime",
          "outputs": [
            {
              "internalType": "uint256",
              "name": "",
              "type": "uint256"
            }
          ],
          "stateMutability": "view",
          "type": "function"
        },
        {
          "inputs": [],
          "name": "timeUntilPayout",
          "outputs": [
            {
              "internalType": "uint256",
              "name": "",
              "type": "uint256"
            }
          ],
          "stateMutability": "view",
          "type": "function"
        },
        {
          "inputs": [],
          "name": "token",
          "outputs": [
            {
              "internalType": "contract IERC20",
              "name": "",
              "type": "address"
            }
          ],
          "stateMutability": "view",
          "type": "function"
        },
        {
          "inputs": [],
          "name": "totalDeposits",
          "outputs": [
            {
              "internalType": "uint256",
              "name": "",
              "type": "uint256"
            }
          ],
          "stateMutability": "view",
          "type": "function"
        },
        {
          "inputs": [
            {
              "internalType": "uint256",
              "name": "amount",
              "type": "uint256"
            }
          ],
          "name": "withdraw",
          "outputs": [],
          "stateMutability": "nonpayable",
          "type": "function"
        }
      
    ];

    // If you deploy from the UI, paste your bytecode (unchanged)
    const TONTINE_BYTECODE = "60e060405234801561000f575f5ffd5b5060405161141838038061141883398181016040528101906100319190610194565b5f73ffffffffffffffffffffffffffffffffffffffff168373ffffffffffffffffffffffffffffffffffffffff160361009f576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016100969061023e565b60405180910390fd5b8273ffffffffffffffffffffffffffffffffffffffff1660808173ffffffffffffffffffffffffffffffffffffffff168152505081426100df9190610289565b60a081815250508060a0516100f49190610289565b60c081815250505050506102bc565b5f5ffd5b5f73ffffffffffffffffffffffffffffffffffffffff82169050919050565b5f61013082610107565b9050919050565b61014081610126565b811461014a575f5ffd5b50565b5f8151905061015b81610137565b92915050565b5f819050919050565b61017381610161565b811461017d575f5ffd5b50565b5f8151905061018e8161016a565b92915050565b5f5f5f606084860312156101ab576101aa610103565b5b5f6101b88682870161014d565b93505060206101c986828701610180565b92505060406101da86828701610180565b9150509250925092565b5f82825260208201905092915050565b7f746f6b656e3d30000000000000000000000000000000000000000000000000005f82015250565b5f6102286007836101e4565b9150610233826101f4565b602082019050919050565b5f6020820190508181035f8301526102558161021c565b9050919050565b7f4e487b71000000000000000000000000000000000000000000000000000000005f52601160045260245ffd5b5f61029382610161565b915061029e83610161565b92508282019050808211156102b6576102b561025c565b5b92915050565b60805160a05160c0516111016103175f395f818161072d0152818161075d0152818161078e01526108f801525f81816104ec0152818161054101526108c901525f818161036401528181610635015261081b01526111015ff3fe608060405234801561000f575f5ffd5b506004361061009c575f3560e01c8063b6b55f2511610064578063b6b55f2514610148578063c4df0c0914610164578063ed5f41ff14610182578063fbcbc0f1146101a0578063fc0c546a146101d15761009c565b80632e1a7d4d146100a05780634a5b5a8a146100bc5780635e5c06e2146100da5780637d8820971461010c578063ae2e933b1461012a575b5f5ffd5b6100ba60048036038101906100b59190610c26565b6101ef565b005b6100c46104ea565b6040516100d19190610c60565b60405180910390f35b6100f460048036038101906100ef9190610cd3565b61050e565b60405161010393929190610cfe565b60405180910390f35b610114610534565b6040516101219190610c60565b60405180910390f35b610132610539565b60405161013f9190610c60565b60405180910390f35b610162600480360381019061015d9190610c26565b61053f565b005b61016c61072a565b6040516101799190610c60565b60405180910390f35b61018a61078c565b6040516101979190610c60565b60405180910390f35b6101ba60048036038101906101b59190610cd3565b6107b0565b6040516101c8929190610d33565b60405180910390f35b6101d9610819565b6040516101e69190610db5565b60405180910390f35b5f60035f3373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020015f2090505f8211610271576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161026890610e28565b60405180910390fd5b81816001015410156102b8576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016102af90610e90565b60405180910390fd5b6102c2338261083d565b5f6102d2338484600101546108b6565b90505f606482856102e39190610edb565b6102ed9190610f49565b90505f81856102fc9190610f79565b905084846001015f8282546103119190610f79565b92505081905550845f5f8282546103289190610f79565b925050819055505f82111561034357610342338386610931565b5b5f845f0154826103539190610fac565b90505f811115610402576103a833827f000000000000000000000000000000000000000000000000000000000000000073ffffffffffffffffffffffffffffffffffffffff166109fc9092919063ffffffff16565b3373ffffffffffffffffffffffffffffffffffffffff167f6c461460f28af1386f23dc4c0c7f4e2e54f0db320a8edc08803e4b787f6db325865f01546040516103f19190610c60565b60405180910390a25f855f01819055505b670de0b6b3a7640000600254866001015461041d9190610edb565b6104279190610f49565b85600201819055505f85600101540361048f573373ffffffffffffffffffffffffffffffffffffffff167f8f420e722d4b21a3e3ef6314f97a0827afa394a45c56d2f53f2b638d1efa845e8285604051610482929190610d33565b60405180910390a26104e2565b3373ffffffffffffffffffffffffffffffffffffffff167f59871fd2a04a78dbcf93dd3000f85ba74bf77974cc7f2f47fdae2be66974b4308783866040516104d993929190610cfe565b60405180910390a25b505050505050565b7f000000000000000000000000000000000000000000000000000000000000000081565b6003602052805f5260405f205f91509050805f0154908060010154908060020154905083565b5f5481565b60015481565b7f000000000000000000000000000000000000000000000000000000000000000042106105a1576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161059890611029565b60405180910390fd5b5f81116105e3576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016105da90610e28565b60405180910390fd5b5f60035f3373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020015f20905061062d338261083d565b61067a3330847f000000000000000000000000000000000000000000000000000000000000000073ffffffffffffffffffffffffffffffffffffffff16610a7b909392919063ffffffff16565b81816001015f82825461068d9190610fac565b92505081905550815f5f8282546106a49190610fac565b92505081905550670de0b6b3a764000060025482600101546106c69190610edb565b6106d09190610f49565b81600201819055503373ffffffffffffffffffffffffffffffffffffffff167f2da466a7b24304f47e87fa2e1e5a81b9831ce54fec19055ce277ca2f39ba42c48360405161071e9190610c60565b60405180910390a25050565b5f7f0000000000000000000000000000000000000000000000000000000000000000421061075a575f9050610789565b427f00000000000000000000000000000000000000000000000000000000000000006107869190610f79565b90505b90565b7f000000000000000000000000000000000000000000000000000000000000000081565b5f5f5f60035f8573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020015f2090506107fc8482610afd565b815f015461080a9190610fac565b92508060010154915050915091565b7f000000000000000000000000000000000000000000000000000000000000000081565b5f6108488383610afd565b90505f811115610884578060015f8282546108639190610f79565b9250508190555080825f015f82825461087c9190610fac565b925050819055505b670de0b6b3a7640000600254836001015461089f9190610edb565b6108a99190610f49565b8260020181905550505050565b5f815f54036108c7575f905061092a565b7f000000000000000000000000000000000000000000000000000000000000000042116108f6575f905061092a565b7f00000000000000000000000000000000000000000000000000000000000000004210610925575f905061092a565b601490505b9392505050565b5f8203156109f7575f5f5490505f826001015490505f81836109539190610f79565b90505f8103610964575050506109f7565b5f81670de0b6b3a76400008761097a9190610edb565b6109849190610f49565b90508060025f8282546109979190610fac565b92505081905550670de0b6b3a76400008186600101546109b79190610edb565b6109c19190610f49565b856002015f8282546109d39190610fac565b925050819055508560015f8282546109eb9190610fac565b92505081905550505050505b505050565b610a76838473ffffffffffffffffffffffffffffffffffffffff1663a9059cbb8585604051602401610a2f929190611056565b604051602081830303815290604052915060e01b6020820180517bffffffffffffffffffffffffffffffffffffffffffffffffffffffff8381831617835250505050610b54565b505050565b610af7848573ffffffffffffffffffffffffffffffffffffffff166323b872dd868686604051602401610ab09392919061107d565b604051602081830303815290604052915060e01b6020820180517bffffffffffffffffffffffffffffffffffffffffffffffffffffffff8381831617835250505050610b54565b50505050565b5f5f670de0b6b3a76400006002548460010154610b1a9190610edb565b610b249190610f49565b905082600201548111610b3a575f915050610b4e565b826002015481610b4a9190610f79565b9150505b92915050565b5f5f60205f8451602086015f885af180610b73576040513d5f823e3d81fd5b3d92505f519150505f8214610b8c576001811415610ba7565b5f8473ffffffffffffffffffffffffffffffffffffffff163b145b15610be957836040517f5274afe7000000000000000000000000000000000000000000000000000000008152600401610be091906110b2565b60405180910390fd5b50505050565b5f5ffd5b5f819050919050565b610c0581610bf3565b8114610c0f575f5ffd5b50565b5f81359050610c2081610bfc565b92915050565b5f60208284031215610c3b57610c3a610bef565b5b5f610c4884828501610c12565b91505092915050565b610c5a81610bf3565b82525050565b5f602082019050610c735f830184610c51565b92915050565b5f73ffffffffffffffffffffffffffffffffffffffff82169050919050565b5f610ca282610c79565b9050919050565b610cb281610c98565b8114610cbc575f5ffd5b50565b5f81359050610ccd81610ca9565b92915050565b5f60208284031215610ce857610ce7610bef565b5b5f610cf584828501610cbf565b91505092915050565b5f606082019050610d115f830186610c51565b610d1e6020830185610c51565b610d2b6040830184610c51565b949350505050565b5f604082019050610d465f830185610c51565b610d536020830184610c51565b9392505050565b5f819050919050565b5f610d7d610d78610d7384610c79565b610d5a565b610c79565b9050919050565b5f610d8e82610d63565b9050919050565b5f610d9f82610d84565b9050919050565b610daf81610d95565b82525050565b5f602082019050610dc85f830184610da6565b92915050565b5f82825260208201905092915050565b7f616d6f756e743d300000000000000000000000000000000000000000000000005f82015250565b5f610e12600883610dce565b9150610e1d82610dde565b602082019050919050565b5f6020820190508181035f830152610e3f81610e06565b9050919050565b7f696e73756666696369656e74206465706f7369746564000000000000000000005f82015250565b5f610e7a601683610dce565b9150610e8582610e46565b602082019050919050565b5f6020820190508181035f830152610ea781610e6e565b9050919050565b7f4e487b71000000000000000000000000000000000000000000000000000000005f52601160045260245ffd5b5f610ee582610bf3565b9150610ef083610bf3565b9250828202610efe81610bf3565b91508282048414831517610f1557610f14610eae565b5b5092915050565b7f4e487b71000000000000000000000000000000000000000000000000000000005f52601260045260245ffd5b5f610f5382610bf3565b9150610f5e83610bf3565b925082610f6e57610f6d610f1c565b5b828204905092915050565b5f610f8382610bf3565b9150610f8e83610bf3565b9250828203905081811115610fa657610fa5610eae565b5b92915050565b5f610fb682610bf3565b9150610fc183610bf3565b9250828201905080821115610fd957610fd8610eae565b5b92915050565b7f456e726f6c6c6d656e7420656e646564000000000000000000000000000000005f82015250565b5f611013601083610dce565b915061101e82610fdf565b602082019050919050565b5f6020820190508181035f83015261104081611007565b9050919050565b61105081610c98565b82525050565b5f6040820190506110695f830185611047565b6110766020830184610c51565b9392505050565b5f6060820190506110905f830186611047565b61109d6020830185611047565b6110aa6040830184610c51565b949350505050565b5f6020820190506110c55f830184611047565b9291505056fea2646970667358221220e3dcd719ce083d470dd14de77ea0764e95adb422c279b753bc002214855a837864736f6c634300081e0033" /* your bytecode here */;

    // --------- STATE ----------
    let provider = null;   // ethers.BrowserProvider
    let signer   = null;   // signer from wallet
    let wallet   = null;
    let currentNet = NETWORKS.sepolia; // default selection
    let dashboard = {};    // map addr -> { addr, tokenDecimals, contract, etherscanBase, interval }

    const $dash = $("#dash");

    // --------- HELPERS ----------
    function fmtNum(x, decimals=6){
      try { return ethers.formatUnits(x ?? 0n, decimals); }
      catch { return String(x); }
    }
    function toUnits(xStr, decimals=6){
      return ethers.parseUnits(String(xStr || "0"), decimals);
    }
    function nowSec(){ return Math.floor(Date.now()/1000); }
    function fmtTs(t){
      if(!t || t==0) return "‚Äî";
      const d = new Date(Number(t) * 1000);
      return d.toLocaleString();
    }
    function updateCountdown(targetSec, el){
      if(!targetSec || targetSec==0){ el.text(""); return; }
      const diff = targetSec - nowSec();
      if(diff <= 0){ el.text("0s"); return; }
      const m = Math.floor(diff/60), s = diff%60, h = Math.floor(m/60), mm = m%60;
      el.text(diff < 3600 ? `${m}m ${s}s` : `${h}h ${mm}m`);
    }

    function addCardHtml(addr, etherscanBase){
      return `
        <div class="card" id="card-${addr.toLowerCase()}">
          <div class="flex">
            <strong class="mono">${addr}</strong>
            <span class="pill">Tontine</span>
            <a class="pill" target="_blank" href="${etherscanBase}/address/${addr}">Etherscan ‚Üó</a>
          </div>
          <div class="hr"></div>
          <div class="grid3">
            <div>
              <div class="muted">Token</div>
              <div class="mono addr" id="token-${addr}">‚Äî</div>
            </div>
            <div>
              <div class="muted">Enrollment Ends</div>
              <div id="enroll-${addr}">‚Äî</div>
              <small id="enrollCountdown-${addr}" class="muted"></small>
            </div>
            <div>
              <div class="muted">Payout Time</div>
              <div id="payout-${addr}">‚Äî</div>
              <small id="payoutCountdown-${addr}" class="muted"></small>
            </div>
          </div>

          <div class="row" style="margin-top:12px">
            <div>
              <div class="muted">Total Deposits</div>
              <div class="mono" id="tot-${addr}">‚Äî</div>
            </div>
            <div>
              <div class="muted">Fee Pool</div>
              <div class="mono" id="fee-${addr}">‚Äî</div>
            </div>
          </div>

          <div class="hr"></div>

          <div class="row">
            <div>
              <label>Your Entitlement</label>
              <div class="mono" id="ent-${addr}">‚Äî</div>
            </div>
            <div>
              <label>Your Deposited</label>
              <div class="mono" id="dep-${addr}">‚Äî</div>
            </div>
          </div>

          <div class="hr"></div>

          <div class="row">
            <div>
              <label>Amount to Deposit (tokens)</label>
              <input id="amtDep-${addr}" placeholder="e.g. 10"/>
              <div class="flex">
                <button class="btnApprove" data-addr="${addr}">Approve Token</button>
                <button class="btnDeposit" data-addr="${addr}">Deposit</button>
              </div>
            </div>
            <div>
              <label>Amount to Withdraw (tokens)</label>
              <input id="amtWdr-${addr}" placeholder="e.g. 5 (partial)"/>
              <div class="flex">
                <button class="btnWithdraw" data-addr="${addr}">Withdraw</button>
                <button class="btnWithdrawAll" data-addr="${addr}">Withdraw All</button>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    async function ensureWalletOnSelected(){
      if (!provider) return;
      const cur = await provider.send("eth_chainId", []);
      if (cur !== currentNet.chainIdHex) {
        try {
          await provider.send("wallet_switchEthereumChain", [{ chainId: currentNet.chainIdHex }]);
        } catch (e) {
          alert(`Please switch your wallet to ${currentNet.name}.`);
          throw e;
        }
      }
    }

    async function refreshOne(addr){
      const rec = dashboard[addr.toLowerCase()];
      if(!rec || !rec.contract) return;
      try{
        const [token, enrollEnd, payout, tot, fee] = await Promise.all([
          rec.contract.tokenAddress(),
          rec.contract.enrollmentEnd(),
          rec.contract.payoutTime(),
          rec.contract.totalDeposits(),
          rec.contract.feePool()
        ]);

        let entitlement = 0n, deposited = 0n;
        if (wallet) {
          const acct = await rec.contract.getAccount(wallet);
          entitlement = acct[0]; deposited = acct[1];
        }

        $(`#token-${addr}`).text(token);
        $(`#enroll-${addr}`).text(fmtTs(enrollEnd));
        $(`#payout-${addr}`).text(fmtTs(payout));
        updateCountdown(Number(enrollEnd), $(`#enrollCountdown-${addr}`));
        updateCountdown(Number(payout),   $(`#payoutCountdown-${addr}`));
        $(`#tot-${addr}`).text(fmtNum(tot, rec.tokenDecimals));
        $(`#fee-${addr}`).text(fmtNum(fee, rec.tokenDecimals));
        $(`#ent-${addr}`).text(fmtNum(entitlement, rec.tokenDecimals));
        $(`#dep-${addr}`).text(fmtNum(deposited, rec.tokenDecimals));
      } catch(e){
        console.error("refreshOne failed", addr, e);
      }
    }

    function startAutoRefresh(addr){
      refreshOne(addr).catch(console.error);
      const id = setInterval(() => refreshOne(addr).catch(console.error), 6000);
      dashboard[addr.toLowerCase()].interval = id;
    }

    async function addTontine(addr, tokenDecimals){
      if (!provider) return alert("Connect wallet first.");
      addr = ethers.getAddress(addr);
      const runner = signer || provider; // both support calls; signer needed for txs
      const contract = new ethers.Contract(addr, TONTINE_ABI, runner);

      dashboard[addr.toLowerCase()] = { addr, tokenDecimals, contract, etherscanBase: currentNet.etherscan };
      $dash.prepend(addCardHtml(addr, currentNet.etherscan));
      startAutoRefresh(addr);
    }

    async function autofillDecimalsForToken(addr){
      try {
        if (!provider) return; // needs wallet connection
        const erc20 = new ethers.Contract(addr, ERC20_ABI, signer || provider);
        const dec = await erc20.decimals();
        $("#inpDecimals").val(Number(dec));
      } catch (e) {
        console.warn("Could not fetch token decimals; using default.", e);
        $("#inpDecimals").val(currentNet.defaultDecimals);
      }
    }

    function setNetworkDefaults(){
      $("#inpToken").val(currentNet.defaultToken);
      $("#inpDecimals").val(currentNet.defaultDecimals);
      $("#netStatus").text(`Network: ${currentNet.name}`);
      // If already connected, try auto-fetching decimals for default token
      if (provider) autofillDecimalsForToken(currentNet.defaultToken);
    }

    // --------- UI HANDLERS ----------
    $("#btnConnect").on("click", async () => {
      if(!window.ethereum){ alert("MetaMask not found."); return; }
      await window.ethereum.request({ method: "eth_requestAccounts" });
      provider = new ethers.BrowserProvider(window.ethereum);

      await ensureWalletOnSelected();

      signer = await provider.getSigner();
      wallet = await signer.getAddress();

      $("#connStatus").text("Connected").removeClass("bad warn").addClass("ok");
      $("#netStatus").text(`Network: ${currentNet.name}`);
      $("#acct").text(wallet);

      // Autofill decimals for the current token now that we can read
      const t = $("#inpToken").val().trim();
      if (ethers.isAddress(t)) autofillDecimalsForToken(t);

      // If you had cards before connecting, rebuild their contract runners
      Object.values(dashboard).forEach(rec => {
        rec.contract = new ethers.Contract(rec.addr, TONTINE_ABI, signer || provider);
        refreshOne(rec.addr);
      });
    });

    $("#btnSwitch").on("click", async () => {
      if(!provider){ return alert("Connect wallet first."); }
      try{
        await ensureWalletOnSelected();
        $("#netStatus").text(`Network: ${currentNet.name}`);
      } catch(e){ console.error(e); }
    });

    $("#networkSelect").on("change", async function(){
      const val = $(this).val();
      currentNet = NETWORKS[val] || NETWORKS.sepolia;
      setNetworkDefaults();

      // Update Etherscan links on existing cards (view-only)
      Object.values(dashboard).forEach(rec => {
        rec.etherscanBase = currentNet.etherscan;
        const $link = $(`#card-${rec.addr.toLowerCase()} a[href*='etherscan']`);
        $link.attr('href', `${currentNet.etherscan}/address/${rec.addr}`);
      });
    });

    $("#inpToken").on("change input", function(){
      const t = $(this).val().trim();
      if (provider && ethers.isAddress(t)) autofillDecimalsForToken(t);
    });

    $("#btnDeploy").on("click", async () => {
      if(!signer) return alert("Connect wallet first.");
      if(!TONTINE_BYTECODE || TONTINE_BYTECODE === "0xYOUR_COMPILED_BYTECODE_HERE"){
        return alert("Please paste your compiled BYTECODE into the page source.");
      }
      try{ await ensureWalletOnSelected(); } catch { return; }

      const token = $("#inpToken").val().trim();
      const decimals = Number($("#inpDecimals").val());
      const enrollMin = Number($("#inpEnrollMin").val());
      const lockMin = Number($("#inpLockMin").val());
      if(!ethers.isAddress(token)) return alert("Invalid token address.");
      if(decimals < 0 || decimals > 36) return alert("Bad decimals.");

      const enrollSec = BigInt(enrollMin * 60);
      const lockSec = BigInt(lockMin * 60);

      try{
        const factory = new ethers.ContractFactory(TONTINE_ABI, TONTINE_BYTECODE, signer);
        const tx = await factory.deploy(token, enrollSec, lockSec);
        await tx.deploymentTransaction().wait();
        const addr = tx.target;
        alert("Deployed at: " + addr);
        addTontine(addr, decimals);
      }catch(e){
        console.error(e);
        alert("Deploy failed: " + (e?.shortMessage || e?.message || e));
      }
    });

    $("#btnAddExisting").on("click", async () => {
      if(!provider) return alert("Connect wallet first.");
      const addr = $("#inpExisting").val().trim();
      if(!ethers.isAddress(addr)) return alert("Invalid address.");
      try{
        // fetch token + decimals via wallet provider
        const ctr = new ethers.Contract(addr, TONTINE_ABI, signer || provider);
        const tokenAdr = await ctr.tokenAddress();
        const erc20 = new ethers.Contract(tokenAdr, ERC20_ABI, signer || provider);
        const dec = await erc20.decimals();
        addTontine(addr, Number(dec));
      }catch(e){
        console.error(e);
        alert("Could not bind to contract‚Äîare ABI, address, and network correct?");
      }
    });

    // Dashboard buttons (txs need signer)
    $("#dash").on("click", ".btnApprove", async function(){
      const key = $(this).data("addr").toLowerCase();
      const rec = dashboard[key];
      if(!rec) return;
      if(!signer) return alert("Connect wallet first.");
      try{
        await ensureWalletOnSelected();
        const tokenAdr = await rec.contract.tokenAddress();
        const erc20 = new ethers.Contract(tokenAdr, ERC20_ABI, signer);
        const human = $(`#amtDep-${rec.addr}`).val().trim();
        if(!human) return alert("Enter amount to approve.");
        const amount = toUnits(human, rec.tokenDecimals);
        const tx = await erc20.approve(rec.addr, amount);
        await tx.wait();
        alert("Approved " + human + " tokens for " + rec.addr);
        refreshOne(rec.addr);
      }catch(e){ console.error(e); alert("Approve failed: "+(e?.shortMessage||e?.message||e)); }
    });

    $("#dash").on("click", ".btnDeposit", async function(){
      const key = $(this).data("addr").toLowerCase();
      const rec = dashboard[key];
      if(!rec) return;
      if(!signer) return alert("Connect wallet first.");
      try{
        await ensureWalletOnSelected();
        const human = $(`#amtDep-${rec.addr}`).val().trim();
        if(!human) return alert("Enter deposit amount.");
        const amount = toUnits(human, rec.tokenDecimals);
        const tx = await rec.contract.deposit(amount);
        await tx.wait();
        alert("Deposited " + human);
        refreshOne(rec.addr);
      }catch(e){ console.error(e); alert("Deposit failed: "+(e?.shortMessage||e?.message||e)); }
    });

    $("#dash").on("click", ".btnWithdraw", async function(){
      const key = $(this).data("addr").toLowerCase();
      const rec = dashboard[key];
      if(!rec) return;
      if(!signer) return alert("Connect wallet first.");
      try{
        await ensureWalletOnSelected();
        const human = $(`#amtWdr-${rec.addr}`).val().trim();
        if(!human) return alert("Enter withdraw amount.");
        const amount = toUnits(human, rec.tokenDecimals);
        const tx = await rec.contract.withdraw(amount);
        await tx.wait();
        alert("Withdrew " + human);
        refreshOne(rec.addr);
      }catch(e){ console.error(e); alert("Withdraw failed: "+(e?.shortMessage||e?.message||e)); }
    });

    $("#dash").on("click", ".btnWithdrawAll", async function(){
      const key = $(this).data("addr").toLowerCase();
      const rec = dashboard[key];
      if(!rec) return;
      if(!signer) return alert("Connect wallet first.");
      try{
        await ensureWalletOnSelected();
        const acct = await rec.contract.getAccount(wallet);
        const deposited = acct[1];
        if (deposited === 0n) return alert("Nothing deposited.");
        const tx = await rec.contract.withdraw(deposited);
        await tx.wait();
        alert("Withdrew all");
        refreshOne(rec.addr);
      }catch(e){ console.error(e); alert("Withdraw failed: "+(e?.shortMessage||e?.message||e)); }
    });

    // --------- INIT ----------
    $(function(){
      // default to Sepolia; user can switch to Mainnet in the selector
      currentNet = NETWORKS.sepolia;
      setNetworkDefaults();
    });
  </script>
</body>
</html>

